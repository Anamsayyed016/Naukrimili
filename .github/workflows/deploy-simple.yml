name: Simple Deploy with PostgreSQL Setup

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Hostinger with PostgreSQL Setup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ðŸš€ Starting automated deployment with PostgreSQL setup..."
            cd /var/www/jobportal
            
            # Pull latest code
            git fetch --all
            git reset --hard origin/main
            
            # ðŸ”´ AUTOMATIC: Setup PostgreSQL if not exists
            if ! systemctl is-active --quiet postgresql; then
              echo "ðŸ”´ Setting up PostgreSQL..."
              sudo apt update
              sudo apt install -y postgresql postgresql-contrib
              sudo systemctl start postgresql
              sudo systemctl enable postgresql
              
              # Create database and user
              sudo -u postgres createdb jobportal || true
              sudo -u postgres createuser jobportal_user || true
              sudo -u postgres psql -c "ALTER USER jobportal_user WITH PASSWORD 'secure_password_123';"
              sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE jobportal TO jobportal_user;"
              
              echo "âœ… PostgreSQL setup complete!"
            else
              echo "âœ… PostgreSQL already running"
            fi
            
            # ðŸ”´ AUTOMATIC: Create production environment
            echo "ðŸ”´ Creating production environment..."
            cat > .env.local << 'ENVEOF'
            NODE_ENV=production
            DATABASE_URL="postgresql://jobportal_user:secure_password_123@localhost:5432/jobportal"
            NEXT_PUBLIC_BASE_URL=https://aftionix.in
            NEXTAUTH_SECRET="your-secret-key-here"
            ENVEOF
            
            echo "âœ… Production environment configured!"
            echo "ðŸ”´ Mock data will be automatically disabled!"
            echo "ðŸš€ PostgreSQL will be automatically used!"
            
            # Install dependencies
            npm install --legacy-peer-deps
            
            # Build application
            echo "ðŸ”¨ Building application..."
            npm run build
            
            if [ $? -eq 0 ]; then
              echo "âœ… Build successful!"
              
              # Restart service
              systemctl restart jobportal
              echo "âœ… Service restarted!"
              
              # Check service status
              systemctl status jobportal --no-pager
              
              echo "ðŸŽ‰ Deployment complete!"
              echo "ðŸ”´ Mock data: DISABLED"
              echo "ðŸš€ PostgreSQL: ACTIVE"
              echo "ðŸŒ Website: https://aftionix.in"
            else
              echo "âŒ Build failed!"
              exit 1
            fi
