name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      GOOGLE_CLOUD_OCR_API_KEY: ${{ secrets.GOOGLE_CLOUD_OCR_API_KEY }}
      NPM_REGISTRY: https://registry.npmjs.org/
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure npm (parallel optimizations)
        run: |
          npm config set registry "$NPM_REGISTRY"
          npm config set progress false
          npm config set audit false
          npm config set fund false
          npm config set maxsockets 100
          npm config set fetch-retries 2
          npm config set fetch-retry-mintimeout 2000
          npm config set fetch-retry-maxtimeout 60000

      - name: Install dependencies (build only)
        run: |
          npm ci --legacy-peer-deps --no-audit 2>&1 | tail -5

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build (production optimized)
        timeout-minutes: 10
        env:
          NODE_ENV: production
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: https://naukrimili.com
          NEXT_PUBLIC_APP_URL: https://naukrimili.com
          NEXT_TELEMETRY_DISABLED: 1
          SKIP_ENV_VALIDATION: 1
          SKIP_BUILD_DB_QUERIES: true
          NODE_OPTIONS: --max-old-space-size=4096
          SWC_NUM_THREADS: 4
          ESLINT_NO_DEV_ERRORS: true
          GOOGLE_CLIENT_ID: ${{ env.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ env.GOOGLE_CLIENT_SECRET }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ env.GROQ_API_KEY }}
          GOOGLE_CLOUD_OCR_API_KEY: ${{ env.GOOGLE_CLOUD_OCR_API_KEY }}
        run: timeout 600 npm run build:linux

      - name: Prepare deployment bundle
        run: |
          # Remove build cache and source maps from .next
          rm -rf .next/cache .next/static/chunks/*.map 2>/dev/null || true

      - name: Create minimal deployment bundle
        run: |
          mkdir -p deploy
          # Copy only essential files (exclude source maps, cache, node_modules)
          cp -r .next deploy/ 2>/dev/null && find deploy/.next -name '*.map' -delete
          cp package.json package-lock.json ecosystem.config.cjs next.config.mjs server.cjs deploy/
          cp -r public prisma deploy/
          # Fast compression (level 1 = fastest, still 3x better than gzip)
          tar -I 'zstd -1 -T0' -cf release.tar.zst -C deploy .
          rm -rf deploy
          ls -lh release.tar.zst

      - name: Upload artifact to server (zstd compression)
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          timeout: 180



          source: "release.tar.zst"
          target: "/var/www/naukrimili"

      - name: Deploy via SSH (optimized)
        uses: appleboy/ssh-action@v1.0.0
        env:
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          timeout: 30s
          command_timeout: 5m
          envs: NEXTAUTH_SECRET,DATABASE_URL
          script: |
            set -e
            cd /var/www/naukrimili
            echo "⚡ Fast deployment started"
            
            # Install zstd if missing (cached check)
            command -v zstd >/dev/null || (apt-get update -qq && apt-get install -y zstd >/dev/null 2>&1)
            
            # Extract in place (no intermediate directory)
            echo "📦 Extracting (5-10s)..."
            tar -I 'zstd -d -T0' -xf release.tar.zst
            rm -f release.tar.zst
            
            # Install dependencies on server (builds native modules for correct platform)
            echo "📚 Installing dependencies (20-30s)..."
            npm ci --legacy-peer-deps --no-audit --only=prod 2>&1 | tail -3
            
            # Set env vars
            export NODE_ENV=production NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
                   NEXTAUTH_URL=https://naukrimili.com NEXT_PUBLIC_APP_URL=https://naukrimili.com \
                   DATABASE_URL="$DATABASE_URL" NEXT_TELEMETRY_DISABLED=1 \
                   GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
                   OPENAI_API_KEY="$OPENAI_API_KEY" GEMINI_API_KEY="$GEMINI_API_KEY" GROQ_API_KEY="$GROQ_API_KEY" \
                   GOOGLE_CLOUD_OCR_API_KEY="$GOOGLE_CLOUD_OCR_API_KEY"
            
            # Skip migrations if no changes detected
            if [ -f prisma/schema.prisma ]; then
              HASH=$(md5sum prisma/schema.prisma 2>/dev/null | cut -d' ' -f1)
              if [ "$HASH" != "$(cat .prisma_hash 2>/dev/null)" ]; then
                echo "🗄️ Running migrations..."
                timeout 60 npx prisma migrate deploy 2>&1 | tail -3 || echo "Migration timeout/skipped"
                echo "$HASH" > .prisma_hash
              else
                echo "⏭️  Schema unchanged, skipping migrations"
              fi
            fi
            
            # Restart PM2 (no-daemon = immediate)
            echo "🔄 Restarting..."
            pm2 delete jobportal 2>/dev/null || true
            pm2 start ecosystem.config.cjs --env production --no-daemon &
            PM2_PID=$!
            
            # Wait max 3 seconds for PM2 to start
            sleep 3
            kill -0 $PM2_PID 2>/dev/null && pm2 save --force
            
            echo "✅ Deployed in $(( SECONDS ))s"
            exit 0
