name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NPM_REGISTRY: https://registry.npmjs.org/
      # API Keys for build and runtime
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      GOOGLE_CLOUD_OCR_API_KEY: ${{ secrets.GOOGLE_CLOUD_OCR_API_KEY }}
      GOOGLE_CLOUD_API_KEY: ${{ secrets.GOOGLE_CLOUD_API_KEY }}
      # OAuth Credentials - CRITICAL: Must be defined here to be used in deployment
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GITHUB_ID: ${{ secrets.GITHUB_ID }}
      GITHUB_SECRET: ${{ secrets.GITHUB_SECRET }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Cache prisma engines
        uses: actions/cache@v4
        with:
          path: ~/.cache/prisma
          key: prisma-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            prisma-${{ runner.os }}-

      - name: Install dependencies
        run: |
          npm ci --legacy-peer-deps --prefer-offline --no-audit

      - name: Build application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          SKIP_ENV_VALIDATION: 1
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          echo "ðŸ“¦ Generating Prisma client..."
          npx prisma generate --skip-engine-check 2>&1 || npx prisma generate || true
          echo "ðŸ—ï¸ Building application..."
          npm run build

      - name: Create deployment bundle
        run: |
          npm prune --production --no-save
          mkdir -p deploy && cd deploy
          cp -r ../.next ../node_modules ../public ../prisma .
          cp ../package.json ../package-lock.json ../ecosystem.config.cjs ../next.config.mjs ../server.cjs .
          if [ -f ../scripts/init-database.sh ]; then
            mkdir -p scripts && cp ../scripts/init-database.sh scripts/
          fi
          cd ..
          tar -I 'zstd -3 --threads=0' -cf release.tar.zst deploy/
          rm -rf deploy
          ls -lh release.tar.zst

      - name: Upload artifact to server
        uses: appleboy/scp-action@v0.1.5
        timeout-minutes: 20
        continue-on-error: false
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "release.tar.zst"
          target: "/var/www/naukrimili"
          timeout: 600s
          strip_components: 0

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        timeout-minutes: 15
        env:
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ env.GROQ_API_KEY }}
          GOOGLE_CLOUD_OCR_API_KEY: ${{ env.GOOGLE_CLOUD_OCR_API_KEY }}
          GOOGLE_CLOUD_API_KEY: ${{ env.GOOGLE_CLOUD_API_KEY }}
          # OAuth Credentials
          GOOGLE_CLIENT_ID: ${{ env.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ env.GOOGLE_CLIENT_SECRET }}
          GITHUB_ID: ${{ env.GITHUB_ID }}
          GITHUB_SECRET: ${{ env.GITHUB_SECRET }}
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          timeout: 120s
          command_timeout: 15m
          envs: NEXTAUTH_SECRET,DATABASE_URL,OPENAI_API_KEY,GEMINI_API_KEY,GROQ_API_KEY,GOOGLE_CLOUD_OCR_API_KEY,GOOGLE_CLOUD_API_KEY,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GITHUB_ID,GITHUB_SECRET
          script: |
            cd /var/www/naukrimili
            
            # Install zstd if needed
            command -v zstd &> /dev/null || (command -v apt-get &> /dev/null && sudo apt-get update -qq && sudo apt-get install -y zstd) || true
            
            # Extract and install
            tar -I 'zstd -d --threads=0' -xf release.tar.zst
            rm -rf .next node_modules
            mv deploy/.next deploy/node_modules deploy/package.json deploy/ecosystem.config.cjs deploy/next.config.mjs deploy/server.cjs deploy/prisma deploy/public .
            [ -d "deploy/scripts" ] && mkdir -p scripts && cp -r deploy/scripts/* scripts/ || true
            rm -rf deploy release.tar.zst
            
            # Setup environment
            export NODE_ENV=production
            export NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            export NEXTAUTH_URL="https://naukrimili.com"
            export NEXT_PUBLIC_APP_URL="https://naukrimili.com"
            export DATABASE_URL="$DATABASE_URL"
            export NEXT_TELEMETRY_DISABLED=1
            export OPENAI_API_KEY="$OPENAI_API_KEY"
            export GEMINI_API_KEY="$GEMINI_API_KEY"
            export GROQ_API_KEY="$GROQ_API_KEY"
            export GOOGLE_CLOUD_OCR_API_KEY="$GOOGLE_CLOUD_OCR_API_KEY"
            export GOOGLE_CLOUD_API_KEY="$GOOGLE_CLOUD_API_KEY"
            export GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
            export GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
            export GITHUB_ID="$GITHUB_ID"
            export GITHUB_SECRET="$GITHUB_SECRET"
            
            # Update .env file
            [ -f .env ] || touch .env
            sed -i '/^GOOGLE_CLIENT_ID=/d; /^GOOGLE_CLIENT_SECRET=/d; /^GITHUB_ID=/d; /^GITHUB_SECRET=/d' .env
            echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
            echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
            echo "GITHUB_ID=$GITHUB_ID" >> .env
            echo "GITHUB_SECRET=$GITHUB_SECRET" >> .env
            
            # Prepare DATABASE_URL (convert localhost to 127.0.0.1)
            if echo "$DATABASE_URL" | grep -q "@localhost:"; then
              DATABASE_URL=$(echo "$DATABASE_URL" | sed 's/@localhost:/@127.0.0.1:/g')
            fi
            export DATABASE_URL
            
            # Optional: Run init-database.sh (non-blocking)
            [ -f "scripts/init-database.sh" ] && chmod +x scripts/init-database.sh && bash scripts/init-database.sh || true
            
            # Run migrations (non-blocking - DB handled manually)
            [ -d "prisma" ] && npx prisma generate --schema=./prisma/schema.prisma || true
            [ -d "prisma" ] && timeout 20 npx prisma migrate deploy --schema=./prisma/schema.prisma || true
            
            # Deploy with PM2
            mkdir -p ./logs
            if pm2 list | grep -q "naukrimili"; then
              pm2 reload naukrimili --update-env --wait-ready
            else
              pm2 start ecosystem.config.cjs --env production --update-env
            fi
            
            # Wait for app to be ready
            for i in {1..30}; do
              if pm2 list | grep -q "naukrimili.*online" && curl -sf --max-time 2 http://127.0.0.1:3000/api/health > /dev/null 2>&1; then
                echo "âœ… App is ready"
                pm2 save
                exit 0
              fi
              sleep 1
            done
            
            pm2 status
            pm2 save
            echo "âœ… Deployment completed"
