name: Auto-Deploy with PostgreSQL Setup

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH with Validation
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          echo "=== SSH Setup Debug ==="
          ls -la ~/.ssh/
          echo "=== Key Content Check ==="
          wc -c ~/.ssh/id_ed25519
          echo "=== Key Format Check ==="
          ssh-keygen -l -f ~/.ssh/id_ed25519 || echo "âŒ SSH key validation failed"
          
          # Validate key format and content
          if [ ! -s ~/.ssh/id_ed25519 ]; then
            echo "ðŸš¨ SSH key is empty or missing"
            echo "ðŸ”§ Please add SSH_PRIVATE_KEY secret to GitHub"
            exit 1
          fi
          
          if ! ssh-keygen -l -f ~/.ssh/id_ed25519 >/dev/null 2>&1; then
            echo "ðŸš¨ SSH key format is invalid or corrupted"
            echo "ðŸ”§ Please regenerate SSH key and update GitHub secrets"
            echo "ðŸ“– Follow the guide: SSH_KEY_FIX.md"
            exit 1
          fi
          
          echo "âœ… SSH key validation successful"

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          if ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} -p ${{ secrets.SSH_PORT }} "echo 'SSH connection successful'"; then
            echo "âœ… SSH connection successful"
          else
            echo "âŒ SSH connection failed"
            echo "ðŸ”§ Please check your SSH configuration:"
            echo "   1. SSH_PRIVATE_KEY secret in GitHub"
            echo "   2. SSH_HOST, SSH_USER, SSH_PORT secrets"
            echo "   3. Server authorized_keys file"
            echo "ðŸ“– Follow the guide: SSH_KEY_FIX.md"
            exit 1
          fi

      - name: Deploy to Hostinger with PostgreSQL Setup
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} -p ${{ secrets.SSH_PORT }} '
            set -e
            echo "ðŸš€ Starting automated deployment with PostgreSQL setup..."
            
            # Navigate to project directory
            cd /var/www/jobportal || { echo "âŒ Directory /var/www/jobportal not found"; exit 1; }
            
            echo "âœ… Current directory: $(pwd)"
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            echo "âœ… Code updated to latest version"
            
            # ðŸ”´ AUTOMATIC: Setup PostgreSQL if not exists
            if ! systemctl is-active --quiet postgresql; then
              echo "ðŸ”´ Setting up PostgreSQL..."
              sudo apt update -y
              sudo apt install -y postgresql postgresql-contrib
              sudo systemctl start postgresql
              sudo systemctl enable postgresql
              
              # Create database and user
              sudo -u postgres createdb jobportal || echo "Database already exists"
              sudo -u postgres createuser jobportal_user || echo "User already exists"
              sudo -u postgres psql -c "ALTER USER jobportal_user WITH PASSWORD '\''secure_password_123'\'';" || echo "Password already set"
              sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE jobportal TO jobportal_user;" || echo "Privileges already granted"
              
              echo "âœ… PostgreSQL setup complete!"
            else
              echo "âœ… PostgreSQL already running"
            fi
            
            # ðŸ”´ AUTOMATIC: Create production environment
            echo "ðŸ”´ Creating production environment..."
            cat > .env.local << "ENVEOF"
            NODE_ENV=production
            DATABASE_URL="postgresql://jobportal_user:secure_password_123@localhost:5432/jobportal"
            NEXT_PUBLIC_BASE_URL=https://aftionix.in
            NEXTAUTH_SECRET="your-secret-key-here"
            ENVEOF
            
            echo "âœ… Production environment configured!"
            echo "ðŸ”´ Mock data will be automatically disabled!"
            echo "ðŸš€ PostgreSQL will be automatically used!"
            
            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps
            
            # Build application
            echo "ðŸ”¨ Building application..."
            npm run build
            
            if [ $? -eq 0 ]; then
              echo "âœ… Build successful!"
              
              # Restart service
              echo "ðŸ”„ Restarting service..."
              systemctl restart jobportal
              echo "âœ… Service restarted!"
              
              # Check service status
              echo "ðŸ“Š Service status:"
              systemctl status jobportal --no-pager
              
              echo "ðŸŽ‰ Deployment complete!"
              echo "ðŸ”´ Mock data: DISABLED"
              echo "ðŸš€ PostgreSQL: ACTIVE"
              echo "ðŸŒ Website: https://aftionix.in"
              
            else
              echo "âŒ Build failed!"
              exit 1
            fi
          '
