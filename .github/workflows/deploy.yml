name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e
            echo "🚀 Starting deployment..."
            
            cd /var/www/naukrimili
            echo "📁 Working in: $(pwd)"
            
            # Stop PM2 process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            git pull origin main
            
            # Clean build artifacts only
            echo "🧹 Cleaning build artifacts..."
            rm -rf .next
            
            # Clean npm cache to fix corrupted packages
            echo "🧹 Cleaning npm cache..."
            npm cache clean --force 2>/dev/null || echo "⚠️ Cache clean failed, continuing..."
            
            # Install dependencies (npm ci is faster than npm install)
            echo "📦 Installing dependencies..."
            npm ci --legacy-peer-deps --no-audit --no-fund 2>&1 || {
              echo "⚠️ npm ci failed, trying npm install..."
              npm install --legacy-peer-deps --no-audit --no-fund
            }
            
            # Generate Prisma client
            npx prisma generate
            
            # Verify critical environment variables exist
            echo "🔍 Verifying environment variables..."
            if [ -f ".env" ]; then
              echo "✅ .env file found"
              # Check if DATABASE_URL exists (critical)
              if grep -q "DATABASE_URL" .env; then
                echo "✅ DATABASE_URL is configured"
              else
                echo "⚠️ DATABASE_URL not found in .env - database features may not work"
              fi
            else
              echo "⚠️ .env file not found - some features may not work"
            fi
            
            # Set environment variables
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=4096"
            
            # Build
            npm run build
            
            if [ ! -d ".next" ]; then
              echo "❌ Build failed"
              exit 1
            fi
            
            echo "✅ Build completed"
            
            # Create logs directory
            mkdir -p ./logs
            
            # Stop any existing PM2 processes completely
            echo "🛑 Ensuring clean PM2 state..."
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            sleep 3
            
            # Start with PM2 and capture any startup errors
            echo "🚀 Starting application with PM2..."
            pm2 start ecosystem.config.cjs --env production --update-env
            
            # Give the server more time to initialize (Next.js can be slow to boot)
            echo "⏳ Waiting 15 seconds for server initialization..."
            sleep 15
            
            # Check PM2 status first
            echo "📊 PM2 Status:"
            pm2 status
            
            # Verify PM2 process is actually running
            if ! pm2 list | grep -q "naukrimili.*online"; then
              echo "❌ PM2 process failed to start or is not online"
              echo "📋 PM2 Logs:"
              pm2 logs naukrimili --lines 100 --nostream || true
              echo "📋 PM2 Process Details:"
              pm2 describe naukrimili || true
              exit 1
            fi
            
            echo "✅ PM2 process is online"
            
            # Health check with detailed debugging
            # Health check with detailed debugging
            echo "🏥 Starting health check..."
            HEALTH_CHECK_PASSED=false
            
            for i in {1..10}; do
              echo "  Attempt $i/10: Checking http://localhost:3000/api/health..."
              
              # Check if port 3000 is listening first
              if netstat -tlnp 2>/dev/null | grep -q ":3000" || ss -tlnp 2>/dev/null | grep -q ":3000"; then
                echo "  ✅ Port 3000 is listening"
                
                # Try health check
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:3000/api/health 2>/dev/null || echo "000")
                
                if [ "$HTTP_CODE" = "200" ]; then
                  echo "✅ Health check passed! (HTTP $HTTP_CODE)"
                  HEALTH_CHECK_PASSED=true
                  break
                else
                  echo "  ⚠️ Health check failed (HTTP $HTTP_CODE)"
                fi
              else
                echo "  ⚠️ Port 3000 is not listening yet"
              fi
              
              if [ $i -lt 10 ]; then
                echo "  Waiting 6 seconds before retry..."
                sleep 6
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "❌ Health check failed after 10 attempts (60 seconds)"
              echo ""
              echo "📋 PM2 Status:"
              pm2 status
              echo ""
              echo "📋 PM2 Logs (last 200 lines):"
              pm2 logs naukrimili --lines 200 --nostream || true
              echo ""
              echo "📋 Checking port 3000:"
              netstat -tlnp 2>/dev/null | grep 3000 || ss -tlnp 2>/dev/null | grep 3000 || echo "Port 3000 not found"
              echo ""
              echo "📋 Testing direct connection:"
              curl -v http://localhost:3000/api/health 2>&1 | head -30 || true
              exit 1
            fi
            
            # Save PM2 process list
            pm2 save
            
            echo "✅ Deployment completed successfully!"
