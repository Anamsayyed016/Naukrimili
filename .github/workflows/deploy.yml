name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NPM_REGISTRY: https://registry.npmjs.org/
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Configure npm
        run: |
          npm config set registry "$NPM_REGISTRY"
          npm config set progress false
          npm config set audit false
          npm config set fund false

      - name: Install dependencies (CI, omit dev)
        run: npm ci --legacy-peer-deps --omit=dev

      - name: Generate Prisma client
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: npx prisma generate

      - name: Build
        env:
          NODE_ENV: production
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: https://naukrimili.com
          NEXT_PUBLIC_APP_URL: https://naukrimili.com
          DATABASE_URL: ${{ env.DATABASE_URL }}
          NEXT_TELEMETRY_DISABLED: 1
          SKIP_ENV_VALIDATION: 1
          NODE_OPTIONS: --max-old-space-size=4096
        run: npm run build

      - name: Package build artifact
        run: |
          tar czf release.tar.gz \
            .next \
            node_modules \
            package.json \
            package-lock.json \
            ecosystem.config.cjs \
            next.config.mjs \
            public \
            prisma \
            server.cjs || true

      - name: Upload artifact to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "release.tar.gz"
          target: "/var/www/naukrimili"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          timeout: 60s
          command_timeout: 20m
          envs: NEXTAUTH_SECRET,DATABASE_URL
          script: |
            set -e
            cd /var/www/naukrimili

            echo "🚀 Unpacking build artifact..."
            rm -rf .next node_modules
            tar xzf release.tar.gz
            rm -f release.tar.gz

            export NODE_ENV=production
            export NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            export NEXTAUTH_URL="https://naukrimili.com"
            export NEXT_PUBLIC_APP_URL="https://naukrimili.com"
            export DATABASE_URL="$DATABASE_URL"
            export NEXT_TELEMETRY_DISABLED=1
            export SKIP_ENV_VALIDATION=1
            export NODE_OPTIONS="--max-old-space-size=4096"

            echo "🚀 Restarting app via PM2..."
            mkdir -p ./logs
            pm2 delete jobportal 2>/dev/null || true
            pm2 start ecosystem.config.cjs --env production --update-env
            sleep 2

            echo "🏥 Health check..."
            for i in {1..5}; do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "✅ App is up"
                break
              fi
              [ $i -lt 5 ] && sleep 1
            done

            pm2 save
            echo "✅ Deployment complete"
