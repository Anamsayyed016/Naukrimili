name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: ğŸ”§ Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies with Node $(node --version)..."
        npm install --legacy-peer-deps --engine-strict=false --force
        
    - name: ğŸ”¨ Build application
      run: |
        echo "ğŸ”¨ Building application with Node $(node --version)..."
        export NEXT_TELEMETRY_DISABLED=1
        export NODE_ENV=production
        export NEXT_PUBLIC_APP_URL=https://aftionix.in
        export NEXTAUTH_URL=https://aftionix.in
        export NEXTAUTH_SECRET=jobportal-secret-key-2024-aftionix-production-deployment
        export JWT_SECRET=jobportal-jwt-secret-2024-aftionix-production
        export DATABASE_URL="postgresql://postgres:password@localhost:5432/jobportal"
        export GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
        export GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
        npx next build
        
    - name: ğŸ” Validate build artifacts
      run: |
        echo "ğŸ” Validating build artifacts..."
        if [ ! -d ".next" ]; then
          echo "âŒ Build failed - .next directory not found"
          exit 1
        fi
        if [ ! -f ".next/BUILD_ID" ]; then
          echo "âŒ Build incomplete - BUILD_ID not found"
          exit 1
        fi
        echo "âœ… Build artifacts validated successfully"
        
    - name: ğŸ› ï¸ Generate server.cjs
      run: |
        echo "ğŸ› ï¸ Generating server.cjs from template..."
        cp server-template.cjs server.cjs || echo "server-template.cjs not found, will create on server"
        
    - name: ğŸ“¥ Prepare SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts
        
    - name: ğŸ“¦ Prepare deployment files
      run: |
        echo "ğŸ“¦ Preparing deployment files..."
        echo "ğŸ“‹ Current working directory: $(pwd)"
        echo "ğŸ“‹ Files to deploy:"
        ls -la | head -10
        echo "ğŸ“‹ Scripts directory:"
        ls -la scripts/ || echo "No scripts directory"
        echo "ğŸ“‹ .next directory:"
        ls -la .next/ || echo "No .next directory"
        
        # Verify build artifacts exist
        echo "ğŸ” Verifying build artifacts..."
        if [ ! -d ".next" ]; then
          echo "âŒ .next directory not found - build failed"
          echo "ğŸ“‹ Current directory contents:"
          ls -la
          exit 1
        fi
        
        if [ ! -f ".next/BUILD_ID" ]; then
          echo "âš ï¸ BUILD_ID not found, creating it..."
          echo $(date +%s) > .next/BUILD_ID
          echo "âœ… BUILD_ID created: $(cat .next/BUILD_ID)"
        fi
        
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found"
          echo "ğŸ“‹ Current directory contents:"
          ls -la
          exit 1
        fi
        
        # Create server.cjs in GitHub Actions runner for verification
        echo "ğŸ”§ Creating server.cjs for verification..."
        cat > server.cjs << 'EOF'
        const { createServer } = require('http');
        const { parse } = require('url');
        const next = require('next');
        
        const dev = process.env.NODE_ENV !== 'production';
        const hostname = process.env.HOSTNAME || '0.0.0.0';
        const port = parseInt(process.env.PORT, 10) || 3000;
        
        console.log('ğŸš€ Starting server...');
        console.log('Environment:', process.env.NODE_ENV);
        console.log('Port:', port);
        console.log('Hostname:', hostname);
        
        const app = next({ 
          dev, 
          hostname, 
          port,
          dir: process.cwd()
        });
        
        const handle = app.getRequestHandler();
        
        app.prepare().then(() => {
          console.log('âœ… Next.js app prepared');
          
          const server = createServer(async (req, res) => {
            try {
              const parsedUrl = parse(req.url, true);
              await handle(req, res, parsedUrl);
            } catch (err) {
              console.error('âŒ Error handling request:', req.url, err);
              res.statusCode = 500;
              res.end('Internal server error');
            }
          });
        
          server.on('error', (err) => {
            console.error('âŒ Server error:', err);
            process.exit(1);
          });
        
          server.listen(port, hostname, (err) => {
            if (err) {
              console.error('âŒ Failed to start server:', err);
              process.exit(1);
            }
            console.log(\`ğŸ‰ Server ready on http://\${hostname}:\${port}\`);
            console.log(\`ğŸ“Š Environment: \${process.env.NODE_ENV}\`);
          });
        }).catch((err) => {
          console.error('âŒ Failed to prepare Next.js app:', err);
          process.exit(1);
        });
        EOF
        
        # Create ecosystem.config.cjs in GitHub Actions runner for verification
        echo "ğŸ”§ Creating ecosystem.config.cjs for verification..."
        cat > ecosystem.config.cjs << 'EOF'
        module.exports = {
          apps: [
            {
              name: "jobportal",
              script: "server.cjs",
              cwd: "/var/www/jobportal",
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: "2G",
              env: {
                NODE_ENV: "production",
                PORT: 3000,
                NODE_OPTIONS: "--max-old-space-size=4096",
                NEXT_TELEMETRY_DISABLED: "1",
                NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                NEXTAUTH_URL: "https://aftionix.in",
                NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
              },
              env_production: {
                NODE_ENV: "production",
                PORT: 3000,
                NODE_OPTIONS: "--max-old-space-size=4096",
                NEXT_TELEMETRY_DISABLED: "1",
                NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                NEXTAUTH_URL: "https://aftionix.in",
                NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
              },
              log_file: "/var/log/jobportal/combined.log",
              out_file: "/var/log/jobportal/out.log",
              error_file: "/var/log/jobportal/error.log",
              log_date_format: "YYYY-MM-DD HH:mm:ss Z",
              merge_logs: true,
              log_type: "json",
              min_uptime: "10s",
              max_restarts: 5,
              restart_delay: 4000,
              exec_mode: "fork",
              ignore_watch: [
                "node_modules",
                ".next",
                "logs",
                "*.log",
                ".git"
              ]
            }
          ]
        };
        EOF
        
        # Verify all files exist
        echo "ğŸ” Verifying all files exist..."
        if [ ! -f "server.cjs" ]; then
          echo "âŒ server.cjs not found"
          exit 1
        fi
        
        if [ ! -f "ecosystem.config.cjs" ]; then
          echo "âŒ ecosystem.config.cjs not found"
          exit 1
        fi
        
        echo "âœ… All build artifacts verified"
        echo "ğŸ“‹ Final file list:"
        ls -la | grep -E "(server\.cjs|ecosystem\.config\.cjs|package\.json|\.next)"

    - name: ğŸ“¤ Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        source: "."
        target: "/var/www/jobportal"
        strip_components: 1
        exclude: |
          .git
          .github
          node_modules
          .next/cache
          logs
          *.log
          coverage
          test-results
          .env.local
          .env.development

    - name: ğŸš€ Deploy to Hostinger VPS
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        timeout: 30m
        command_timeout: 28m
        debug: true
        script_stop: true
        script: |
          set -e
          echo "ğŸš€ Starting production deployment..."
          
          # Test SSH connection
          echo "ğŸ” Testing SSH connection..."
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Available space: $(df -h . | tail -1)"
          
          # Create project directory
          echo "ğŸ“ Creating project directory..."
          sudo mkdir -p /var/www/jobportal
          sudo chown -R $USER:$USER /var/www/jobportal
          
          # Navigate to project directory
          cd /var/www/jobportal
          echo "ğŸ“ Working in: $(pwd)"
          
          # Verify files were copied
          echo "ğŸ” Verifying copied files..."
          echo "ğŸ“‹ Current working directory: $(pwd)"
          echo "ğŸ“‹ Directory contents:"
          ls -la
          
          # Check for specific files
          echo "ğŸ” Checking for specific files..."
          echo "ğŸ“‹ package.json:"
          ls -la package.json || echo "âŒ package.json not found"
          echo "ğŸ“‹ server.cjs:"
          ls -la server.cjs || echo "âŒ server.cjs not found"
          echo "ğŸ“‹ ecosystem.config.cjs:"
          ls -la ecosystem.config.cjs || echo "âŒ ecosystem.config.cjs not found"
          echo "ğŸ“‹ .next directory:"
          ls -la .next/ || echo "âŒ .next directory not found"
          
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found - files not copied properly"
            echo "ğŸ“‹ Directory contents:"
            ls -la
            echo "ğŸ“‹ Checking if files are in subdirectories:"
            find . -name "package.json" -type f 2>/dev/null || echo "No package.json found anywhere"
            find . -name "server.cjs" -type f 2>/dev/null || echo "No server.cjs found anywhere"
            find . -name "ecosystem.config.cjs" -type f 2>/dev/null || echo "No ecosystem.config.cjs found anywhere"
            find . -name ".next" -type d 2>/dev/null || echo "No .next directory found anywhere"
            exit 1
          fi
          
          # Create missing files if they don't exist
          if [ ! -f "server.cjs" ]; then
            echo "âš ï¸ server.cjs not found, creating it..."
            cat > server.cjs << 'EOF'
          const { createServer } = require('http');
          const { parse } = require('url');
          const next = require('next');
          
          const dev = process.env.NODE_ENV !== 'production';
          const hostname = process.env.HOSTNAME || '0.0.0.0';
          const port = parseInt(process.env.PORT, 10) || 3000;
          
          console.log('ğŸš€ Starting server...');
          console.log('Environment:', process.env.NODE_ENV);
          console.log('Port:', port);
          console.log('Hostname:', hostname);
          
          const app = next({ 
            dev, 
            hostname, 
            port,
            dir: process.cwd()
          });
          
          const handle = app.getRequestHandler();
          
          app.prepare().then(() => {
            console.log('âœ… Next.js app prepared');
            
            const server = createServer(async (req, res) => {
              try {
                const parsedUrl = parse(req.url, true);
                await handle(req, res, parsedUrl);
              } catch (err) {
                console.error('âŒ Error handling request:', req.url, err);
                res.statusCode = 500;
                res.end('Internal server error');
              }
            });
          
            server.on('error', (err) => {
              console.error('âŒ Server error:', err);
              process.exit(1);
            });
          
            server.listen(port, hostname, (err) => {
              if (err) {
                console.error('âŒ Failed to start server:', err);
                process.exit(1);
              }
              console.log(\`ğŸ‰ Server ready on http://\${hostname}:\${port}\`);
              console.log(\`ğŸ“Š Environment: \${process.env.NODE_ENV}\`);
            });
          }).catch((err) => {
            console.error('âŒ Failed to prepare Next.js app:', err);
            process.exit(1);
          });
          EOF
            echo "âœ… server.cjs created"
          fi
          
          if [ ! -f "ecosystem.config.cjs" ]; then
            echo "âš ï¸ ecosystem.config.cjs not found, creating it..."
            cat > ecosystem.config.cjs << 'EOF'
          module.exports = {
            apps: [
              {
                name: "jobportal",
                script: "server.cjs",
                cwd: "/var/www/jobportal",
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: "2G",
                env: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                env_production: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                log_file: "/var/log/jobportal/combined.log",
                out_file: "/var/log/jobportal/out.log",
                error_file: "/var/log/jobportal/error.log",
                log_date_format: "YYYY-MM-DD HH:mm:ss Z",
                merge_logs: true,
                log_type: "json",
                min_uptime: "10s",
                max_restarts: 5,
                restart_delay: 4000,
                exec_mode: "fork",
                ignore_watch: [
                  "node_modules",
                  ".next",
                  "logs",
                  "*.log",
                  ".git"
                ]
              }
            ]
          };
          EOF
            echo "âœ… ecosystem.config.cjs created"
          fi
          
          if [ ! -d ".next" ]; then
            echo "âš ï¸ .next directory not found, building on server..."
            npm install --legacy-peer-deps --force
            npm run build
            if [ ! -d ".next" ]; then
              echo "âŒ Build failed, .next directory still not found"
              exit 1
            fi
          fi
          
          echo "âœ… Files successfully prepared on server"
          
          # Create BUILD_ID if missing
          echo "ğŸ” Checking BUILD_ID..."
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âš ï¸ BUILD_ID not found, creating it..."
            echo $(date +%s) > .next/BUILD_ID
            echo "âœ… BUILD_ID created: $(cat .next/BUILD_ID)"
          else
            echo "âœ… BUILD_ID found: $(cat .next/BUILD_ID)"
          fi
          
          # Create server.cjs file
          echo "ğŸ”§ Creating server.cjs..."
          cat > server.cjs << 'EOF'
          const { createServer } = require('http');
          const { parse } = require('url');
          const next = require('next');
          
          const dev = process.env.NODE_ENV !== 'production';
          const hostname = process.env.HOSTNAME || '0.0.0.0';
          const port = parseInt(process.env.PORT, 10) || 3000;
          
          console.log('ğŸš€ Starting server...');
          console.log('Environment:', process.env.NODE_ENV);
          console.log('Port:', port);
          console.log('Hostname:', hostname);
          
          const app = next({ 
            dev, 
            hostname, 
            port,
            dir: process.cwd()
          });
          
          const handle = app.getRequestHandler();
          
          app.prepare().then(() => {
            console.log('âœ… Next.js app prepared');
            
            const server = createServer(async (req, res) => {
              try {
                const parsedUrl = parse(req.url, true);
                await handle(req, res, parsedUrl);
              } catch (err) {
                console.error('âŒ Error handling request:', req.url, err);
                res.statusCode = 500;
                res.end('Internal server error');
              }
            });
          
            server.on('error', (err) => {
              console.error('âŒ Server error:', err);
              process.exit(1);
            });
          
            server.listen(port, hostname, (err) => {
              if (err) {
                console.error('âŒ Failed to start server:', err);
                process.exit(1);
              }
              console.log(\`ğŸ‰ Server ready on http://\${hostname}:\${port}\`);
              console.log(\`ğŸ“Š Environment: \${process.env.NODE_ENV}\`);
            });
          }).catch((err) => {
            console.error('âŒ Failed to prepare Next.js app:', err);
            process.exit(1);
          });
          EOF
          
          # Create ecosystem.config.cjs file
          echo "ğŸ”§ Creating ecosystem.config.cjs..."
          cat > ecosystem.config.cjs << 'EOF'
          module.exports = {
            apps: [
              {
                name: "jobportal",
                script: "server.cjs",
                cwd: "/var/www/jobportal",
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: "2G",
                env: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                env_production: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                log_file: "/var/log/jobportal/combined.log",
                out_file: "/var/log/jobportal/out.log",
                error_file: "/var/log/jobportal/error.log",
                log_date_format: "YYYY-MM-DD HH:mm:ss Z",
                merge_logs: true,
                log_type: "json",
                min_uptime: "10s",
                max_restarts: 5,
                restart_delay: 4000,
                exec_mode: "fork",
                ignore_watch: [
                  "node_modules",
                  ".next",
                  "logs",
                  "*.log",
                  ".git"
                ]
              }
            ]
          };
          EOF
          
          # Create production .env file
          echo "ğŸ”§ Creating production .env file..."
          cat > .env << 'EOF'
          DATABASE_URL="postgresql://postgres:password@localhost:5432/jobportal"
          NEXTAUTH_URL="https://aftionix.in"
          NEXTAUTH_SECRET="jobportal-secret-key-2024-aftionix-production-deployment"
          JWT_SECRET="jobportal-jwt-secret-2024-aftionix-production"
          NODE_ENV=production
          NEXT_TELEMETRY_DISABLED=1
          NEXT_PUBLIC_APP_URL=https://aftionix.in
          NEXT_PUBLIC_SKIP_GOOGLE_FONTS=true
          EOF
          
          # Create .npmrc file
          echo "ğŸ”§ Creating .npmrc file..."
          cat > .npmrc << 'EOF'
          engine-strict=false
          legacy-peer-deps=true
          fund=false
          audit=false
          loglevel=error
          auto-install-peers=true
          EOF
          
          echo "âœ… Server files created successfully"
          
          # Check Node version and install if needed
          NODE_VERSION=$(node --version 2>/dev/null || echo "not-installed")
          echo "ğŸ” Current Node version: $NODE_VERSION"
          if [[ ! "$NODE_VERSION" =~ ^v20\. ]]; then
            echo "ğŸ“¦ Installing Node.js 20.x..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
            echo "âœ… Node.js installed: $(node --version)"
          fi
          
          # Install jq for JSON parsing (needed for PM2 status checks)
          echo "ğŸ“¦ Installing jq for JSON parsing..."
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq || echo "âš ï¸ jq installation failed, will use fallback methods"
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y jq || echo "âš ï¸ jq installation failed, will use fallback methods"
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y jq || echo "âš ï¸ jq installation failed, will use fallback methods"
          else
            echo "âš ï¸ No compatible package manager found, will use fallback methods"
          fi
          
          # Install curl if not available (needed for health checks)
          echo "ğŸ“¦ Installing curl for health checks..."
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get install -y curl || echo "âš ï¸ curl installation failed"
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y curl || echo "âš ï¸ curl installation failed"
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y curl || echo "âš ï¸ curl installation failed"
          else
            echo "âš ï¸ No compatible package manager found for curl"
          fi
          
          # Create BUILD_ID if missing
          echo "ğŸ” Checking BUILD_ID..."
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âš ï¸ BUILD_ID not found, creating it..."
            echo $(date +%s) > .next/BUILD_ID
            echo "âœ… BUILD_ID created: $(cat .next/BUILD_ID)"
          else
            echo "âœ… BUILD_ID found: $(cat .next/BUILD_ID)"
          fi
          
          # Create server.cjs file
          echo "ğŸ”§ Creating server.cjs..."
          cat > server.cjs << 'EOF'
          const { createServer } = require('http');
          const { parse } = require('url');
          const next = require('next');
          
          const dev = process.env.NODE_ENV !== 'production';
          const hostname = process.env.HOSTNAME || '0.0.0.0';
          const port = parseInt(process.env.PORT, 10) || 3000;
          
          console.log('ğŸš€ Starting server...');
          console.log('Environment:', process.env.NODE_ENV);
          console.log('Port:', port);
          console.log('Hostname:', hostname);
          
          const app = next({ 
            dev, 
            hostname, 
            port,
            dir: process.cwd()
          });
          
          const handle = app.getRequestHandler();
          
          app.prepare().then(() => {
            console.log('âœ… Next.js app prepared');
            
            const server = createServer(async (req, res) => {
              try {
                const parsedUrl = parse(req.url, true);
                await handle(req, res, parsedUrl);
              } catch (err) {
                console.error('âŒ Error handling request:', req.url, err);
                res.statusCode = 500;
                res.end('Internal server error');
              }
            });
          
            server.on('error', (err) => {
              console.error('âŒ Server error:', err);
              process.exit(1);
            });
          
            server.listen(port, hostname, (err) => {
              if (err) {
                console.error('âŒ Failed to start server:', err);
                process.exit(1);
              }
              console.log(\`ğŸ‰ Server ready on http://\${hostname}:\${port}\`);
              console.log(\`ğŸ“Š Environment: \${process.env.NODE_ENV}\`);
            });
          }).catch((err) => {
            console.error('âŒ Failed to prepare Next.js app:', err);
            process.exit(1);
          });
          EOF
          
          # Create ecosystem.config.cjs file
          echo "ğŸ”§ Creating ecosystem.config.cjs..."
          cat > ecosystem.config.cjs << 'EOF'
          module.exports = {
            apps: [
              {
                name: "jobportal",
                script: "server.cjs",
                cwd: "/var/www/jobportal",
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: "2G",
                env: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                env_production: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                log_file: "/var/log/jobportal/combined.log",
                out_file: "/var/log/jobportal/out.log",
                error_file: "/var/log/jobportal/error.log",
                log_date_format: "YYYY-MM-DD HH:mm:ss Z",
                merge_logs: true,
                log_type: "json",
                min_uptime: "10s",
                max_restarts: 5,
                restart_delay: 4000,
                exec_mode: "fork",
                ignore_watch: [
                  "node_modules",
                  ".next",
                  "logs",
                  "*.log",
                  ".git"
                ]
              }
            ]
          };
          EOF
          
          # Create production .env file
          echo "ğŸ”§ Creating production .env file..."
          cat > .env << 'EOF'
          DATABASE_URL="postgresql://postgres:password@localhost:5432/jobportal"
          NEXTAUTH_URL="https://aftionix.in"
          NEXTAUTH_SECRET="jobportal-secret-key-2024-aftionix-production-deployment"
          JWT_SECRET="jobportal-jwt-secret-2024-aftionix-production"
          NODE_ENV=production
          NEXT_TELEMETRY_DISABLED=1
          NEXT_PUBLIC_APP_URL=https://aftionix.in
          NEXT_PUBLIC_SKIP_GOOGLE_FONTS=true
          EOF
          
          # Create .npmrc file
          echo "ğŸ”§ Creating .npmrc file..."
          cat > .npmrc << 'EOF'
          engine-strict=false
          legacy-peer-deps=true
          fund=false
          audit=false
          loglevel=error
          auto-install-peers=true
          EOF
          
          echo "âœ… Server files created successfully"
          
          # Force kill all PM2 processes and clean up
          echo "ğŸ’€ Force killing all PM2 processes..."
          pm2 kill || true
          pm2 flush || true
          
          # Clean up previous build artifacts (but preserve .next from local build)
          echo "ğŸ§¹ Cleaning up previous build artifacts..."
          rm -rf node_modules
          
          # Verify files were copied
          echo "ğŸ” Verifying copied files..."
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found after copy"
            echo "ğŸ“‹ Directory contents:"
            ls -la /var/www/jobportal/ || echo "Directory not accessible"
            echo "ğŸ“‹ Checking source directory:"
            ls -la /github/workspace/ || echo "Source directory not accessible"
            exit 1
          fi
          
          # Check for other critical files
          if [ ! -f "next.config.js" ] && [ ! -f "next.config.mjs" ]; then
            echo "âš ï¸ Next.js config not found, but continuing..."
          fi
          
          if [ ! -d "prisma" ]; then
            echo "âš ï¸ Prisma directory not found, but continuing..."
          fi
          
          echo "âœ… Files copied successfully"
          
          # Verify .next directory was copied from GitHub Actions
          echo "ğŸ” Verifying .next directory..."
          if [ ! -d ".next" ]; then
            echo "âš ï¸ .next directory not found - build artifacts not copied"
            echo "ğŸ“‹ Directory contents:"
            ls -la
            echo "ğŸ“‹ Checking if .next exists in parent directory:"
            ls -la ../.next/ || echo "No .next in parent directory"
            echo "ğŸ“‹ Checking if .next exists in /tmp:"
            ls -la /tmp/.next/ || echo "No .next in /tmp"
            
            # Try to build on server as fallback
            echo "ğŸ”„ Attempting to build on server as fallback..."
            if command -v npm >/dev/null 2>&1; then
              echo "ğŸ“¦ Installing dependencies for build..."
              npm install --legacy-peer-deps --force
              echo "ğŸ”¨ Building application on server..."
              npm run build
              if [ -d ".next" ]; then
                echo "âœ… Build successful, .next directory created"
              else
                echo "âŒ Build failed, .next directory still not found"
                echo "ğŸ“‹ Checking build logs..."
                echo "ğŸ“‹ Directory contents after build:"
                ls -la
                exit 1
              fi
            else
              echo "âŒ npm not available, cannot build on server"
              echo "ğŸ“‹ Node version: $(node --version 2>/dev/null || echo 'not available')"
              echo "ğŸ“‹ npm version: $(npm --version 2>/dev/null || echo 'not available')"
            exit 1
            fi
          else
            echo "âœ… .next directory found"
            echo "ğŸ“‹ .next directory contents:"
            ls -la .next/ | head -10
          fi
          
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âš ï¸ BUILD_ID not found, creating it..."
            echo $(date +%s) > .next/BUILD_ID
            echo "âœ… BUILD_ID created: $(cat .next/BUILD_ID)"
          else
            echo "âœ… BUILD_ID found: $(cat .next/BUILD_ID)"
          fi
          
          echo "âœ… Build artifacts verified"
          if [ ! -f "server.cjs" ]; then
            echo "âŒ server.cjs not found on server"
            echo "ğŸ“‹ Available files:"
            ls -la *.cjs *.js 2>/dev/null || echo "No server files found"
            exit 1
          fi
          
          echo "âœ… Build artifacts verified on server"
          
          # Generate server files directly
          echo "ğŸ”§ Generating server files..."
          
          # Create server.cjs
          cat > server.cjs << 'EOF'
          const { createServer } = require('http');
          const { parse } = require('url');
          const next = require('next');
          
          const dev = process.env.NODE_ENV !== 'production';
          const hostname = process.env.HOSTNAME || '0.0.0.0';
          const port = parseInt(process.env.PORT, 10) || 3000;
          
          console.log('ğŸš€ Starting server...');
          console.log('Environment:', process.env.NODE_ENV);
          console.log('Port:', port);
          console.log('Hostname:', hostname);
          
          const app = next({ 
            dev, 
            hostname, 
            port,
            dir: process.cwd()
          });
          
          const handle = app.getRequestHandler();
          
          app.prepare().then(() => {
            console.log('âœ… Next.js app prepared');
            
            const server = createServer(async (req, res) => {
              try {
                const parsedUrl = parse(req.url, true);
                await handle(req, res, parsedUrl);
              } catch (err) {
                console.error('âŒ Error handling request:', req.url, err);
                res.statusCode = 500;
                res.end('Internal server error');
              }
            });
          
            server.on('error', (err) => {
              console.error('âŒ Server error:', err);
              process.exit(1);
            });
          
            server.listen(port, hostname, (err) => {
              if (err) {
                console.error('âŒ Failed to start server:', err);
                process.exit(1);
              }
              console.log(\`ğŸ‰ Server ready on http://\${hostname}:\${port}\`);
              console.log(\`ğŸ“Š Environment: \${process.env.NODE_ENV}\`);
            });
          }).catch((err) => {
            console.error('âŒ Failed to prepare Next.js app:', err);
            process.exit(1);
          });
          EOF
          
          # Create ecosystem.config.cjs
          cat > ecosystem.config.cjs << 'EOF'
          module.exports = {
            apps: [
              {
                name: "jobportal",
                script: "server.cjs",
                cwd: "/var/www/jobportal",
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: "2G",
                env: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                env_production: {
                  NODE_ENV: "production",
                  PORT: 3000,
                  NODE_OPTIONS: "--max-old-space-size=4096",
                  NEXT_TELEMETRY_DISABLED: "1",
                  NEXT_PUBLIC_SKIP_GOOGLE_FONTS: "true",
                  NEXT_PUBLIC_APP_URL: "https://aftionix.in",
                  NEXTAUTH_URL: "https://aftionix.in",
                  NEXTAUTH_SECRET: "jobportal-secret-key-2024-aftionix-production-deployment",
                  JWT_SECRET: "jobportal-jwt-secret-2024-aftionix-production",
                  DATABASE_URL: "postgresql://postgres:password@localhost:5432/jobportal"
                },
                log_file: "/var/log/jobportal/combined.log",
                out_file: "/var/log/jobportal/out.log",
                error_file: "/var/log/jobportal/error.log",
                log_date_format: "YYYY-MM-DD HH:mm:ss Z",
                merge_logs: true,
                log_type: "json",
                min_uptime: "10s",
                max_restarts: 5,
                restart_delay: 4000,
                exec_mode: "fork",
                ignore_watch: [
                  "node_modules",
                  ".next",
                  "logs",
                  "*.log",
                  ".git"
                ]
              }
            ]
          };
          EOF
          
          echo "âœ… Server files generated successfully"
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps --force
          
          echo "âœ… Dependencies installed successfully"
          
          # Generate Prisma client (if Prisma is used)
          if [ -d "prisma" ] && [ -f "prisma/schema.prisma" ]; then
            echo "ğŸ—„ï¸ Generating Prisma client..."
            npx prisma generate
            echo "âœ… Prisma client generated successfully"
          else
            echo "âš ï¸ Prisma not found, skipping Prisma client generation"
          fi
          
          # Create log directory
          echo "ğŸ“ Creating log directory..."
          sudo mkdir -p /var/log/jobportal
          sudo chown -R $USER:$USER /var/log/jobportal
          
          echo "âœ… Environment variables configured"
          
          # Start the application with PM2
          echo "ğŸš€ Starting application with PM2..."
          
          # Ensure PM2 is available
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "âŒ PM2 not available, installing..."
            npm install -g pm2 || {
              echo "âŒ Failed to install PM2"
              exit 1
            }
          fi
          
          # Verify server files exist
          echo "ğŸ” Verifying server files..."
          if [ ! -f "server.cjs" ]; then
            echo "âŒ server.cjs not found"
            exit 1
          fi
          
          if [ ! -f "ecosystem.config.cjs" ]; then
            echo "âŒ ecosystem.config.cjs not found"
            exit 1
          fi
          
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found"
            exit 1
          fi
          
          if [ ! -d ".next" ]; then
            echo "âŒ .next directory not found"
            exit 1
          fi
          
          echo "âœ… All server files verified"
          
          # Start the application
          pm2 start ecosystem.config.cjs --env production
          
          # Wait for PM2 to start
          echo "â³ Waiting for PM2 to start..."
          sleep 15
          
          # Save PM2 configuration
          echo "ğŸ’¾ Saving PM2 configuration..."
          pm2 save
          
          # Setup PM2 startup
          echo "ğŸ”„ Setting up PM2 startup..."
          pm2 startup systemd -u $USER --hp $HOME || echo "âš ï¸ PM2 startup setup failed, but continuing..."
          
          # Check PM2 status
          echo "ğŸ” PM2 Status:"
          pm2 status
            
            # Check if port is listening
          echo "ğŸ” Checking if port 3000 is listening..."
            if netstat -tlnp | grep -q ":3000"; then
              echo "âœ… Port 3000 is listening"
              
            # Test basic connectivity
            echo "ğŸ” Testing application response..."
            if curl -f -s --max-time 10 http://localhost:3000/ > /dev/null 2>&1; then
              echo "âœ… Application is responding"
            else
              echo "âš ï¸ Application not responding yet - may need more time"
              echo "ğŸ“‹ Checking PM2 logs for errors..."
              pm2 logs jobportal --lines 20 --nostream || echo "Could not retrieve PM2 logs"
            fi
          else
            echo "âŒ Port 3000 not listening"
            echo "ğŸ“‹ Checking PM2 logs..."
            pm2 logs jobportal --lines 20 --nostream || echo "Could not retrieve PM2 logs"
            echo "ğŸ“‹ Checking if server.cjs exists and is valid..."
            if [ -f "server.cjs" ]; then
              echo "âœ… server.cjs exists"
              echo "ğŸ“‹ server.cjs size: $(wc -c < server.cjs) bytes"
              echo "ğŸ“‹ First 5 lines of server.cjs:"
              head -5 server.cjs
            else
              echo "âŒ server.cjs not found"
            fi
            echo "ğŸ“‹ Checking if ecosystem.config.cjs exists and is valid..."
            if [ -f "ecosystem.config.cjs" ]; then
              echo "âœ… ecosystem.config.cjs exists"
              echo "ğŸ“‹ ecosystem.config.cjs size: $(wc -c < ecosystem.config.cjs) bytes"
            else
              echo "âŒ ecosystem.config.cjs not found"
            fi
                exit 1
          fi
          
          echo "âœ… Production deployment completed successfully!"
          echo "ğŸŒ Application is available at: http://localhost:3000"
          echo "ğŸ“Š Final Status:"
          pm2 status