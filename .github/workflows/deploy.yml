name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy via SSH (Build on Server)
      uses: appleboy/ssh-action@v1.0.3
      timeout-minutes: 40
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        timeout: 35m
        command_timeout: 30m
        script: |
          #!/bin/bash
          set -e
          echo "ğŸš€ Starting deployment at $(date)"
          
          # Navigate to project directory
          cd /var/www/naukrimili
          echo "ğŸ“ Working in: $(pwd)"
          
          # Stop PM2 first to free up memory
          echo "ğŸ›‘ Stopping PM2..."
          pm2 stop naukrimili 2>/dev/null || true
          pm2 delete naukrimili 2>/dev/null || true
          
          # Pull latest code from git
          echo "ğŸ“¥ Pulling latest code..."
          timeout 2m git fetch origin main || echo "Fetch completed"
          timeout 1m git reset --hard origin/main || echo "Reset completed"
          timeout 2m git pull origin main || echo "Pull completed"
          
          # Clean previous builds
          echo "ğŸ§¹ Cleaning previous builds..."
          rm -rf .next
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing dependencies..."
          timeout 10m npm ci --legacy-peer-deps --ignore-scripts --no-audit --no-fund || {
            echo "âš ï¸ npm ci failed, trying npm install..."
            timeout 10m npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
          }
          
          # Generate Prisma client
          echo "ğŸ—„ï¸ Generating Prisma client..."
          timeout 5m npx prisma generate || {
            echo "âš ï¸ Prisma generate timed out"
            exit 1
          }
          
          # Build application
          echo "ğŸ”¨ Building application..."
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          # Build with timeout (30 minutes max)
          timeout 30m npm run build || {
            echo "âŒ Build timed out or failed"
            exit 1
          }
          
          # Verify build
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "âœ… Build completed"
          du -sh .next
          
          # Create logs directory
          mkdir -p ./logs
          
          # Start with PM2
          echo "ğŸš€ Starting with PM2..."
          pm2 start ecosystem.config.cjs --env production --update-env
          
          # Wait for startup
          echo "â³ Waiting for app to initialize..."
          sleep 15
          
          # Check status
          echo "ğŸ“Š PM2 Status:"
          pm2 status | head -20
          
          # Health check
          echo "ğŸ¥ Running health check..."
          HEALTH_PASSED=false
          for i in {1..5}; do
            if curl -f -s --max-time 10 http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              HEALTH_PASSED=true
              break
            else
              echo "âŒ Health check failed (attempt $i/5)"
              if [ $i -lt 5 ]; then
                sleep 5
              fi
            fi
          done
          
          # Save PM2 configuration
          pm2 save
          
          if [ "$HEALTH_PASSED" = true ]; then
            echo "âœ… Deployment completed successfully!"
          else
            echo "âš ï¸ Deployment completed but health check failed"
          fi
          
          # Show recent logs (timeout after 5 seconds)
          timeout 5 pm2 logs naukrimili --lines 20 --nostream || echo "ğŸ“‹ Logs retrieved"
          
          echo "ğŸ¯ Deployment script finished"
