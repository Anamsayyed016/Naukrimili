name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 60m
          script: |
            set -e
            echo "🚀 Starting deployment..."

            cd /var/www/naukrimili
            echo "📁 Working in: $(pwd)"
            
            # Stop PM2 process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            git pull origin main
            
            # Clean build
            rm -rf .next
            rm -rf node_modules 2>/dev/null || true
            
            # Configure npm for fast, reliable installs
            npm config set cache ~/.npm
            npm config set registry https://registry.npmjs.org/
            npm config set fetch-timeout 60000
            npm config set fetch-retry-mintimeout 10000
            npm config set fetch-retry-maxtimeout 60000
            
            # Test registry connectivity
            echo "🌐 Testing npm registry connectivity..."
            npm ping --registry https://registry.npmjs.org/ || echo "⚠️ Registry ping failed, but continuing..."
            
            # Install dependencies deterministically using lockfile
            echo "📦 Installing production dependencies (npm ci)..."
            timeout 300 npm ci --omit=dev --legacy-peer-deps --ignore-scripts --no-audit --no-fund 2>&1 || {
              echo "⚠️ npm ci failed or timed out, retrying without timeout..."
              npm ci --omit=dev --legacy-peer-deps --ignore-scripts --no-audit --no-fund --loglevel=verbose
            }

            # Generate Prisma client
            echo "🔧 Generating Prisma client..."
            npx prisma generate
            
            # Set environment variables
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=4096"
            export NEXTAUTH_SECRET="naukrimili-secret-key-2024-production-deployment"
            export NEXTAUTH_URL="https://naukramili.com"

            # Build with simple direct approach (no retry overhead)
            echo "🔨 Building application..."
            
            NODE_ENV=production \
            NEXT_TELEMETRY_DISABLED=1 \
            NODE_OPTIONS="--max-old-space-size=4096" \
            NEXTAUTH_SECRET="naukrimili-secret-key-2024-production-deployment" \
            NEXTAUTH_URL="https://naukrimili.com" \
            npm run build 2>&1 | tee build.log || {
              echo "❌ Build failed - showing last 50 lines of output:"
              tail -50 build.log
              exit 1
            }
            
            echo "✅ Build completed successfully"

            # Create logs directory
            mkdir -p ./logs

            # Start with PM2
            echo "🚀 Starting application with PM2..."
            pm2 start ecosystem.config.cjs --env production --update-env

            sleep 3

            # Quick health check (3 attempts instead of 5)
            echo "🏥 Health check..."
            for i in {1..3}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:3000/api/health 2>/dev/null || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Health check passed (HTTP $HTTP_CODE)"
                break
              else
                echo "⚠️ Attempt $i/3 failed (HTTP $HTTP_CODE)"
                [ $i -lt 3 ] && sleep 2
              fi
            done

            # Save PM2 process list
            pm2 save

            echo "✅ Deployment completed successfully!"
