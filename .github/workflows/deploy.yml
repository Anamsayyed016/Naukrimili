name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NPM_REGISTRY: https://registry.npmjs.org/
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Configure npm (optimized)
        run: |
          npm config set registry "$NPM_REGISTRY"
          npm config set progress false
          npm config set audit false
          npm config set fund false
          npm config set maxsockets 50
          npm config set prefer-offline true

      - name: Install dependencies (optimized)
        run: |
          npm ci --legacy-peer-deps --prefer-offline --no-audit --silent 2>&1 | tail -20 || true

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          npx prisma generate --skip-engine-check 2>/dev/null || npx prisma generate

      - name: Build application
        env:
          NODE_ENV: production
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: https://naukrimili.com
          NEXT_PUBLIC_APP_URL: https://naukrimili.com
          DATABASE_URL: ${{ env.DATABASE_URL }}
          NEXT_TELEMETRY_DISABLED: 1
          SKIP_ENV_VALIDATION: 1
          NODE_OPTIONS: --max-old-space-size=4096
          SWC_NUM_THREADS: 4
        run: |
          npm run build

      - name: Prepare deployment bundle
        run: |
          # Remove dev dependencies and unnecessary files
          npm prune --production --no-save --silent
          
          # Remove unnecessary files from node_modules (faster compression)
          find node_modules -type f \( -name "*.md" -o -name "*.ts" -o -name "*.map" -o -name "*.test.*" -o -name "*.spec.*" \) -delete 2>/dev/null || true
          
          # Remove build cache and source maps
          rm -rf .next/cache .next/static/chunks/*.map 2>/dev/null || true
          
          # Create deployment bundle (only essential files)
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/ 2>/dev/null || true
          cp -r prisma deploy/ 2>/dev/null || true
          cp package.json package-lock.json deploy/
          cp ecosystem.config.cjs next.config.mjs server.cjs deploy/ 2>/dev/null || true
          
          # Create .env file with database connection pooling
          cat > deploy/.env << EOF
          NODE_ENV=production
          NEXTAUTH_URL=https://naukrimili.com
          NEXT_PUBLIC_APP_URL=https://naukrimili.com
          NEXT_TELEMETRY_DISABLED=1
          NEXTAUTH_SECRET=${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL=${{ env.DATABASE_URL }}
          EOF
          
          # Ensure DATABASE_URL has connection pooling parameters
          if ! echo "${{ env.DATABASE_URL }}" | grep -q "connection_limit"; then
            echo "⚠️ WARNING: DATABASE_URL missing connection pooling parameters"
            echo "   Add: ?connection_limit=10&pool_timeout=20&connect_timeout=10"
          fi

      - name: Compress bundle (fast compression)
        run: |
          # Use gzip instead of xz for faster compression (xz -9 is very slow)
          tar -czf release.tar.gz -C deploy .
          ls -lh release.tar.gz

      - name: Upload to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "release.tar.gz"
          target: "/var/www/naukrimili"
          strip_components: 0

      - name: Deploy and restart
        uses: appleboy/ssh-action@v1.0.0
        env:
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          timeout: 30s
          command_timeout: 5m
          envs: NEXTAUTH_SECRET,DATABASE_URL
          script: |
            set -e
            cd /var/www/naukrimili
            
            echo "⚡ Starting fast deployment..."
            START_TIME=$(date +%s)
            
            # Backup current version
            if [ -d .next ]; then
              echo "📦 Backing up current version..."
              cp -r .next .next.backup.$(date +%s) 2>/dev/null || true
            fi
            
            # Extract bundle
            echo "📦 Extracting bundle..."
            tar -xzf release.tar.gz -C . 2>/dev/null || tar -xzf release.tar.gz
            
            # Ensure .env exists and has correct DATABASE_URL
            if [ ! -f .env ]; then
              echo "📝 Creating .env file..."
              cat > .env << EOF
            NODE_ENV=production
            NEXTAUTH_URL=https://naukrimili.com
            NEXT_PUBLIC_APP_URL=https://naukrimili.com
            NEXT_TELEMETRY_DISABLED=1
            NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            DATABASE_URL="$DATABASE_URL"
            EOF
            else
              # Update DATABASE_URL in existing .env if needed
              if ! grep -q "connection_limit" .env 2>/dev/null; then
                echo "🔧 Adding connection pooling to DATABASE_URL..."
                sed -i 's|DATABASE_URL="\(.*\)"|DATABASE_URL="\1?connection_limit=10&pool_timeout=20&connect_timeout=10&socket_timeout=30"|' .env 2>/dev/null || true
              fi
            fi
            
            # Verify DATABASE_URL is set
            if [ -z "$DATABASE_URL" ]; then
              echo "❌ ERROR: DATABASE_URL not set!"
              exit 1
            fi
            
            # Test database connection before restarting
            echo "🔍 Testing database connection..."
            if command -v psql >/dev/null 2>&1; then
              DB_CONN=$(echo "$DATABASE_URL" | sed -n 's/.*:\/\/\([^:]*\):\([^@]*\)@\([^:]*\):\([^/]*\)\/\(.*\)/\1 \2 \3 \4 \5/p')
              if [ -n "$DB_CONN" ]; then
                echo "✅ Database connection string parsed"
              fi
            fi
            
            # Install production dependencies on server (if package.json changed)
            echo "📦 Installing/updating dependencies..."
            npm ci --production --legacy-peer-deps --prefer-offline --no-audit --silent 2>&1 | tail -10 || true
            
            # Generate Prisma client on server
            echo "🔧 Generating Prisma client..."
            npx prisma generate --skip-engine-check 2>/dev/null || npx prisma generate
            
            # Validate deployment configuration
            echo "🔍 Validating deployment configuration..."
            if [ -f scripts/validate-deployment.js ]; then
              node scripts/validate-deployment.js || echo "⚠️ Validation script not found or failed (continuing)"
            fi
            
            # Restart PM2 with zero-downtime
            echo "🔄 Restarting application..."
            pm2 delete naukrimili 2>/dev/null || true
            pm2 start ecosystem.config.cjs --env production --update-env --no-wait || pm2 restart naukrimili --update-env
            
            # Wait for app to be ready
            echo "⏳ Waiting for application to start..."
            for i in {1..30}; do
              if curl -sf --max-time 2 http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "✅ Application is healthy"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "⚠️ Health check timeout (app may still be starting)"
                pm2 logs naukrimili --lines 20 --nostream
                exit 0
              fi
              sleep 1
            done
            
            # Test database health endpoint
            echo "🔍 Testing database health..."
            if curl -sf --max-time 5 http://localhost:3000/api/health/database > /dev/null 2>&1; then
              echo "✅ Database connection verified"
            else
              echo "⚠️ Database health check failed (check logs)"
              pm2 logs naukrimili --lines 30 --nostream | grep -i "database\|prisma\|error" || true
            fi
            
            # Cleanup
            rm -f release.tar.gz
            find . -name ".next.backup.*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
            
            # Save PM2 process list
            pm2 save
            
            ELAPSED=$(( $(date +%s) - START_TIME ))
            echo "✅ Deployment complete in ${ELAPSED}s"
            echo "📊 PM2 Status:"
            pm2 status
