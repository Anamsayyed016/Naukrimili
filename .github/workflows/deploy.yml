name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      GOOGLE_CLOUD_OCR_API_KEY: ${{ secrets.GOOGLE_CLOUD_OCR_API_KEY }}
      NPM_REGISTRY: https://registry.npmjs.org/
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure npm (parallel optimizations)
        run: |
          npm config set registry "$NPM_REGISTRY"
          npm config set progress false
          npm config set audit false
          npm config set fund false
          npm config set maxsockets 128
          npm config set fetch-retries 1
          npm config set fetch-retry-mintimeout 1000

      - name: Install dependencies (build only)
        run: |
          npm ci --legacy-peer-deps --no-audit --prefer-offline 2>&1 | tail -3

      - name: Generate Prisma Client
        env:
          SKIP_DB_VALIDATION: true
        run: |
          echo "🔧 Generating Prisma Client..."
          npx prisma generate --skip-validation 2>&1 || npx prisma generate 2>&1
          GEN_EXIT=$?
          
          if [ $GEN_EXIT -ne 0 ]; then
            echo "❌ Prisma generation failed with exit code $GEN_EXIT"
            exit $GEN_EXIT
          fi
          
          if [ ! -d lib/generated/prisma/client ]; then
            echo "⚠️  Warning: Prisma client directory not found at lib/generated/prisma/client"
          else
            echo "✅ Prisma client generated successfully"
          fi

      - name: Build (production optimized)
        timeout-minutes: 8
        env:
          NODE_ENV: production
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: https://naukrimili.com
          NEXT_PUBLIC_APP_URL: https://naukrimili.com
          NEXT_TELEMETRY_DISABLED: 1
          SKIP_ENV_VALIDATION: 1
          SKIP_DB_VALIDATION: true
          SKIP_BUILD_DB_QUERIES: true
          DATABASE_URL: ""
          NODE_OPTIONS: --max-old-space-size=4096
          SWC_NUM_THREADS: 4
          ESLINT_NO_DEV_ERRORS: true
          GOOGLE_CLIENT_ID: ${{ env.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ env.GOOGLE_CLIENT_SECRET }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ env.GROQ_API_KEY }}
          GOOGLE_CLOUD_OCR_API_KEY: ${{ env.GOOGLE_CLOUD_OCR_API_KEY }}
        run: |
          echo "🔨 Starting production build..."
          echo "📍 Current directory: $(pwd)"
          echo "🔧 Node version: $(node --version)"
          echo "📦 npm version: $(npm --version)"
          
          # Configure npm for reliable builds
          npm config set progress false
          npm config set audit false
          npm config set fund false
          npm config set fetch-retries 3
          npm config set loglevel verbose
          
          # Run build without timeout to see full error messages
          npm run build:linux 2>&1
          BUILD_EXIT=$?
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo ""
            echo "❌ Build failed with exit code $BUILD_EXIT"
            echo ""
            echo "📁 Directory contents after failed build:"
            ls -lah | head -30
            exit $BUILD_EXIT
          fi
          
          # Verify build output
          if [ ! -d .next ]; then
            echo "❌ CRITICAL: Build failed - .next directory not created"
            echo "📁 Current directory contents:"
            ls -lah
            echo ""
            echo "🔍 Total disk usage:"
            du -sh . | head -5
            exit 1
          fi
          
          NEXT_SIZE=$(du -sh .next | cut -f1)
          echo "✅ Build completed successfully"
          echo "📊 Build output size: $NEXT_SIZE"
          
          # Extra verification - count files in .next
          FILE_COUNT=$(find .next -type f | wc -l)
          echo "📈 Number of files in .next: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -lt 100 ]; then
            echo "⚠️  WARNING: Unusually low file count in .next directory"
          fi

      - name: Prepare deployment bundle
        run: |
          echo "🧹 Cleaning build artifacts..."
          # Remove build cache and source maps from .next only
          rm -rf .next/cache 2>/dev/null || true
          find .next/static -name '*.map' -delete 2>/dev/null || true
          echo "✅ Build artifacts cleaned"

      - name: Create minimal deployment bundle
        run: |
          set -e
          echo "📁 Creating deployment bundle..."
          
          if [ ! -d .next ]; then
            echo "❌ CRITICAL: .next directory not found!"; exit 1
          fi
          
          echo "✅ .next directory found ($(du -sh .next | cut -f1))"
          
          DEPLOY_DIR="/tmp/naukrimili_deploy_$$"
          mkdir -p "$DEPLOY_DIR"
          
          # Copy only essential files
          cp -r .next "$DEPLOY_DIR/"
          find "$DEPLOY_DIR/.next" -name '*.map' -delete 2>/dev/null || true
          find "$DEPLOY_DIR/.next/cache" -type f -delete 2>/dev/null || true
          
          for file in package.json package-lock.json ecosystem.config.cjs next.config.mjs server.cjs; do
            [ -f "$file" ] && cp "$file" "$DEPLOY_DIR/"
          done
          
          [ -d public ] && cp -r public "$DEPLOY_DIR/"
          [ -d prisma ] && cp -r prisma "$DEPLOY_DIR/"
          
          # Create tar.zst
          cd "$DEPLOY_DIR"
          tar -I 'zstd -1 -T0' -cf ../release.tar.zst . || { echo "❌ tar failed"; exit 1; }
          cd - > /dev/null
          
          mv "$DEPLOY_DIR/release.tar.zst" release.tar.zst 2>/dev/null || mv "$DEPLOY_DIR/../release.tar.zst" release.tar.zst
          
          [ ! -f release.tar.zst ] && { echo "❌ release.tar.zst not created"; exit 1; }
          
          BUNDLE_SIZE=$(ls -lh release.tar.zst | awk '{print $5}')
          echo "✅ Bundle created: $BUNDLE_SIZE"
          
          rm -rf "$DEPLOY_DIR"

      - name: Fast upload and deploy
        run: |
          set -e
          
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ env.SSH_PORT }} ${{ env.HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "📤 Uploading bundle..."
          rsync -avz --progress \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no" \
            release.tar.zst ${{ env.SSH_USER }}@${{ env.HOST }}:/var/www/naukrimili/
          
          echo "✅ Upload complete"

      - name: Deploy via SSH (ultra-fast)
        env:
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          GOOGLE_CLIENT_ID: ${{ env.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ env.GOOGLE_CLIENT_SECRET }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ env.GROQ_API_KEY }}
          GOOGLE_CLOUD_OCR_API_KEY: ${{ env.GOOGLE_CLOUD_OCR_API_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            ${{ env.SSH_USER }}@${{ env.HOST }} \
            "NEXTAUTH_SECRET='$NEXTAUTH_SECRET' \
             DATABASE_URL='$DATABASE_URL' \
             GOOGLE_CLIENT_ID='$GOOGLE_CLIENT_ID' \
             GOOGLE_CLIENT_SECRET='$GOOGLE_CLIENT_SECRET' \
             OPENAI_API_KEY='$OPENAI_API_KEY' \
             GEMINI_API_KEY='$GEMINI_API_KEY' \
             GROQ_API_KEY='$GROQ_API_KEY' \
             GOOGLE_CLOUD_OCR_API_KEY='$GOOGLE_CLOUD_OCR_API_KEY' \
             bash -s <<DEPLOY_SCRIPT
          set -euo pipefail
          START_TIME=$(date +%s)
          cd /var/www/naukrimili
          echo "⚡ Fast deployment started"
          
          # Install zstd if missing
          if ! command -v zstd >/dev/null 2>&1; then
            apt-get update -qq
            apt-get install -y zstd >/dev/null 2>&1 || true
          fi
          
          # Extract
          echo "📦 Extracting..."
          tar -I 'zstd -d -T0' -xf release.tar.zst && rm -f release.tar.zst
          
          # Ultra-fast dependency handling
          LOCKFILE_HASH=$(md5sum package-lock.json 2>/dev/null | cut -d' ' -f1)
          PREV_HASH=$(cat .lock_hash 2>/dev/null || echo "none")
          
          if [ -d node_modules ] && [ "$LOCKFILE_HASH" = "$PREV_HASH" ]; then
            echo "⏭️  Skipping npm install (unchanged)"
          else
            echo "📚 Installing production deps..."
            # Configure npm for maximum speed
            npm config set cache /var/www/naukrimili/.npm-cache
            npm config set registry https://registry.npmjs.org/
            npm config set prefer-offline true
            npm config set fund false
            npm config set audit false
            npm config set progress false
            npm config set fetch-retries 2
            npm config set fetch-retry-mintimeout 500
            npm config set fetch-retry-maxtimeout 2000
            npm config set maxsockets 100
            npm config set loglevel error
            
            # Use npm install for faster execution on server (incremental)
            if ! timeout 90 npm install --omit=dev --no-audit --prefer-offline --no-fund --loglevel=error; then
              echo "⚠️  npm install failed/slow, trying clean install..."
              rm -rf node_modules package-lock.json
              timeout 120 npm install --omit=dev --no-audit --no-fund --loglevel=error || { echo "❌ npm failed"; exit 1; }
            fi
            echo "$LOCKFILE_HASH" > .lock_hash
          fi
          
          # Set env vars
          export NODE_ENV=production \
                 NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
                 NEXTAUTH_URL=https://naukrimili.com \
                 NEXT_PUBLIC_APP_URL=https://naukrimili.com \
                 DATABASE_URL="$DATABASE_URL" \
                 NEXT_TELEMETRY_DISABLED=1 \
                 GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
                 GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
                 OPENAI_API_KEY="$OPENAI_API_KEY" \
                 GEMINI_API_KEY="$GEMINI_API_KEY" \
                 GROQ_API_KEY="$GROQ_API_KEY" \
                 GOOGLE_CLOUD_OCR_API_KEY="$GOOGLE_CLOUD_OCR_API_KEY"
          
          # Migrations (skip if unchanged)
          if [ -f prisma/schema.prisma ]; then
            SCHEMA_HASH=$(md5sum prisma/schema.prisma 2>/dev/null | cut -d' ' -f1)
            if [ "$SCHEMA_HASH" != "$(cat .prisma_hash 2>/dev/null)" ]; then
              echo "🗄️  Running migrations..."
              timeout 45 npx prisma migrate deploy 2>&1 | tail -2 || echo "Migration skipped"
              echo "$SCHEMA_HASH" > .prisma_hash
            else
              echo "⏭️  Schema unchanged"
            fi
          fi
          
          # Restart PM2
          echo "🔄 Restarting..."
          pm2 delete jobportal 2>/dev/null || true
          pm2 start ecosystem.config.cjs --env production
          sleep 2
          pm2 save --force >/dev/null 2>&1
          
          END_TIME=$(date +%s)
          DURATION=$(expr $END_TIME - $START_TIME)
          echo "✅ Deployed in ${DURATION}s"
          exit 0
          DEPLOY_SCRIPT
