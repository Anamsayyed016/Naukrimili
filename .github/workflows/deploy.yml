name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 60m
          script: |
            set -e
            echo "🚀 Starting deployment..."

            cd /var/www/naukrimili
            echo "📁 Working in: $(pwd)"

            # Stop PM2 process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            git pull origin main

            # Verify critical deployment files exist
            echo "✅ Verifying critical deployment files..."
            if [ ! -f "server.cjs" ]; then
              echo "❌ server.cjs not found after git pull!"
              echo "📁 Current directory contents:"
              ls -la | grep -E "\.(cjs|js)$" | head -20
              exit 1
            fi
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "❌ ecosystem.config.cjs not found after git pull!"
              exit 1
            fi
            echo "✅ Critical files verified: server.cjs and ecosystem.config.cjs exist"

            # Clean build
            rm -rf .next

            # Optimize npm cache before install
            echo "🔧 Optimizing npm cache..."
            npm cache clean --force 2>/dev/null || true
            
            # Install dependencies (with timeout and progress monitoring)
            echo "📦 Installing dependencies (this may take 5-10 minutes)..."
            echo "📊 Progress:"
            timeout 30m npm install --legacy-peer-deps --no-audit --no-fund --prefer-offline --no-save --ignore-scripts 2>&1 | tee npm-install.log || {
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                echo "❌ npm install timed out after 30 minutes"
                echo "📋 Last 100 lines of install log:"
                tail -100 npm-install.log
                exit 1
              elif [ $EXIT_CODE -ne 0 ]; then
                echo "❌ npm install failed with exit code $EXIT_CODE"
                tail -100 npm-install.log
                exit 1
              fi
            }
            echo "✅ Dependencies installed successfully"

            # Verify critical dependencies are present (quick check only)
            echo "✅ Skipping additional dependency checks (npm install ensured completeness)"

            # Generate Prisma client
            echo "🔧 Generating Prisma client..."
            npx prisma generate

            # Set environment variables
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=4096"
            export NEXTAUTH_SECRET="naukrimili-secret-key-2024-production-deployment"
            export NEXTAUTH_URL="https://naukrimili.com"

            # Build with error handling and fallback
            echo "🔨 Building application..."
            BUILD_SUCCESS=false

            # Method 1: Try npm run build
            if npm run build 2>&1; then
              echo "✅ Build completed successfully with npm run build"
              BUILD_SUCCESS=true
            else
              echo "❌ Build failed with npm run build"
              echo "🔄 Trying fallback build command (without cross-env)..."
              
              # Method 2: Try build:fallback script
              if npm run build:fallback 2>&1; then
                echo "✅ Fallback build completed successfully"
                BUILD_SUCCESS=true
              else
                echo "❌ Fallback build script also failed"
                echo "🔄 Trying method 3: Direct next build with environment variables..."
                
                # Method 3: Build directly with environment variables set
                if NODE_ENV=production \
                  NEXT_TELEMETRY_DISABLED=1 \
                  NODE_OPTIONS="--max-old-space-size=4096" \
                  NEXTAUTH_SECRET="naukrimili-secret-key-2024-production-deployment" \
                  NEXTAUTH_URL="https://naukrimili.com" \
                  npx next build 2>&1; then
                  echo "✅ Direct build completed successfully"
                  BUILD_SUCCESS=true
                else
                  echo "❌ Direct build also failed"
                  echo "🔄 Trying method 4: Minimal build command..."
                  
                  # Method 4: Minimal build command
                  if NODE_ENV=production NODE_OPTIONS="--max-old-space-size=4096" npx next build --no-lint 2>&1; then
                    echo "✅ Minimal build completed successfully"
                    BUILD_SUCCESS=true
                  else
                    echo "❌ All build methods failed"
                    echo "📋 Checking for common build issues..."
                    echo "  - Node version: $(node --version)"
                    echo "  - npm version: $(npm --version)"
                    echo "  - .next directory exists: $([ -d .next ] && echo 'yes' || echo 'no')"
                    echo "  - package.json exists: $([ -f package.json ] && echo 'yes' || echo 'no')"
                    echo "  - node_modules exists: $([ -d node_modules ] && echo 'yes' || echo 'no')"
                    echo "  - next installed: $(npm list next 2>/dev/null | grep next@ || echo 'NOT FOUND')"
                    echo "  - prisma installed: $(npm list prisma 2>/dev/null | grep prisma@ || echo 'NOT FOUND')"
                    echo ""
                    echo "📋 Last 50 lines of build output:"
                    tail -50 npm-debug.log 2>/dev/null || echo "No debug log found"
                    exit 1
                  fi
                fi
              fi
            fi

            if [ "$BUILD_SUCCESS" = false ]; then
              echo "❌ All build attempts failed"
              exit 1
            fi

            # Verify build output
            echo "🔍 Verifying build artifacts..."
            if [ ! -d ".next" ]; then
              echo "❌ .next directory not found after build"
              echo "📋 Current directory contents:"
              ls -la
              exit 1
            fi

            # Verify critical build files
            if [ ! -f ".next/BUILD_ID" ]; then
              echo "❌ .next/BUILD_ID not found"
              echo "📋 .next directory contents:"
              ls -la .next/ | head -20
              exit 1
            fi

            if [ ! -d ".next/server" ]; then
              echo "❌ .next/server directory not found"
              echo "📋 .next directory contents:"
              ls -la .next/ | head -20
              exit 1
            fi

            # Verify static directory exists (critical for production)
            if [ ! -d ".next/static" ]; then
              echo "⚠️ .next/static directory missing - creating it..."
              mkdir -p .next/static
              echo "⚠️ Manual static directory created, but this indicates a build issue"
            fi

            # Verify static directory has content
            if [ -z "$(ls -A .next/static 2>/dev/null)" ]; then
              echo "⚠️ .next/static directory is empty - this may cause runtime issues"
            else
              echo "✅ Static files generated successfully"
            fi

            echo "✅ Build verification completed"
            echo "📋 Build artifacts:"
            echo "  - .next/BUILD_ID: $([ -f .next/BUILD_ID ] && echo '✅' || echo '❌')"
            echo "  - .next/server: $([ -d .next/server ] && echo '✅' || echo '❌')"
            echo "  - .next/static: $([ -d .next/static ] && echo '✅' || echo '❌')"

            # Create logs directory
            mkdir -p ./logs

            # Start with PM2
            echo "🚀 Starting application with PM2..."

            # Verify critical files exist
            echo "🔍 Verifying deployment files..."
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "❌ ecosystem.config.cjs not found!"
              echo "📋 Current directory contents:"
              ls -la *.cjs *.js 2>/dev/null || echo "No .cjs or .js files found"
              exit 1
            fi

            if [ ! -f "server.cjs" ]; then
              echo "❌ server.cjs not found!"
              echo "📋 Current directory contents:"
              ls -la *.cjs *.js 2>/dev/null || echo "No .cjs or .js files found"
              exit 1
            fi

            echo "✅ All deployment files verified"

            # Stop and delete existing process
            echo "🛑 Stopping existing PM2 processes..."
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true
            sleep 2

            # Start PM2 with production environment
            echo "🚀 Starting PM2 with ecosystem.config.cjs..."
            pm2 start ecosystem.config.cjs --env production --update-env || {
              echo "❌ PM2 start failed"
              echo "📋 PM2 error details:"
              pm2 logs --lines 50 --nostream || true
              exit 1
            }

            # Wait for app to start and verify PM2 status
            echo "⏳ Waiting for application to start..."
            sleep 10

            # Check PM2 status
            echo "📊 PM2 Status:"
            pm2 status

            # Verify PM2 process is running
            PM2_STATUS=$(pm2 jlist | grep -o '"status":"[^"]*"' | head -1 || echo "")
            if ! pm2 list | grep -q "naukrimili.*online"; then
              echo "❌ PM2 process is not online"
              echo "📋 PM2 Status Details:"
              pm2 describe naukrimili || echo "Process not found"
              echo ""
              echo "📋 PM2 Error Logs (last 100 lines):"
              pm2 logs naukrimili --err --lines 100 --nostream || echo "No error logs"
              echo ""
              echo "📋 PM2 Output Logs (last 50 lines):"
              pm2 logs naukrimili --out --lines 50 --nostream || echo "No output logs"
              echo ""
              echo "🔍 Checking if port 3000 is in use:"
              netstat -tlnp 2>/dev/null | grep 3000 || ss -tlnp 2>/dev/null | grep 3000 || echo "Port 3000 not found"
              echo ""
              echo "🔍 Checking if .next directory exists:"
              ls -la .next/ 2>/dev/null | head -10 || echo ".next directory not found"
              exit 1
            fi

            echo "✅ PM2 process is running"

            # Health check with better error handling
            echo "🏥 Starting health check..."
            HEALTH_CHECK_PASSED=false
            for i in {1..5}; do
              echo "  Attempt $i/5: Checking http://localhost:3000/api/health..."
              
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:3000/api/health 2>/dev/null || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Health check passed! (HTTP $HTTP_CODE)"
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "⚠️ Health check failed (HTTP $HTTP_CODE) - attempt $i/5"
                if [ $i -lt 5 ]; then
                  echo "  Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done

            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "❌ Health check failed after 5 attempts"
              echo ""
              echo "📋 PM2 Status:"
              pm2 status
              echo ""
              echo "📋 PM2 Error Logs (last 100 lines):"
              pm2 logs naukrimili --err --lines 100 --nostream || echo "No error logs"
              echo ""
              echo "📋 PM2 Output Logs (last 100 lines):"
              pm2 logs naukrimili --out --lines 100 --nostream || echo "No output logs"
              echo ""
              echo "📋 PM2 Process Details:"
              pm2 describe naukrimili || echo "Process not found"
              echo ""
              echo "🌐 Testing if port 3000 is listening:"
              netstat -tlnp 2>/dev/null | grep 3000 || ss -tlnp 2>/dev/null | grep 3000 || echo "Port 3000 not found in listening ports"
              echo ""
              echo "🔍 Testing localhost connection:"
              curl -v http://localhost:3000 2>&1 | head -20 || echo "Connection failed"
              echo ""
              echo "🔍 Checking server.cjs exists:"
              ls -la server.cjs || echo "server.cjs not found"
              exit 1
            fi

            # Save PM2 process list
            pm2 save

            echo "✅ Deployment completed successfully!"
