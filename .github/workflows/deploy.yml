name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy via SSH (Build on Server)
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        timeout: 40m
        command_timeout: 38m
        debug: true
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /var/www/naukrimili
          echo "ğŸ“ Working in: $(pwd)"
          
          # Stop PM2 first to free up memory
          echo "ğŸ›‘ Stopping PM2..."
          pm2 stop naukrimili 2>/dev/null || true
          pm2 delete naukrimili 2>/dev/null || true
          
          # Pull latest code from git
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main
          git pull origin main
          
          # Clean previous builds
          echo "ğŸ§¹ Cleaning previous builds..."
          rm -rf .next
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps --ignore-scripts --no-audit --no-fund || {
            echo "âš ï¸ npm ci failed, trying npm install..."
            npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
          }
          
          # Generate Prisma client
          echo "ğŸ—„ï¸ Generating Prisma client..."
          npx prisma generate
          
          # Build application
          echo "ğŸ”¨ Building application..."
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          export NODE_OPTIONS="--max-old-space-size=4096"
          npm run build
          
          # Verify build
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "âœ… Build completed"
          du -sh .next
          
          # Create logs directory
          mkdir -p ./logs
          
          # Start with PM2
          echo "ğŸš€ Starting with PM2..."
          pm2 start ecosystem.config.cjs --env production
          
          # Wait for startup
          sleep 10
          
          # Check status
          echo "ğŸ“Š PM2 Status:"
          pm2 status
          
          # Health check
          echo "ğŸ¥ Running health check..."
          for i in {1..5}; do
            if curl -f -s --max-time 10 http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              break
            else
              echo "âŒ Health check failed (attempt $i/5)"
              sleep 5
            fi
          done
          
          # Save PM2 configuration
          pm2 save
          
          echo "âœ… Deployment completed successfully!"
          pm2 logs naukrimili --lines 50 --nostream
