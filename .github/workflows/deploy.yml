name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          timeout: 60s
          command_timeout: 60m
          envs: NEXTAUTH_SECRET,DATABASE_URL
          script: |
            set -e
            echo "🚀 Starting deployment..."

            cd /var/www/naukrimili
            echo "📁 Working in: $(pwd)"
            
            # Stop PM2 process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            git pull origin main
            
            # Basic cleanup
            echo "🧹 Cleaning build artifacts..."
            rm -rf .next 2>/dev/null || true
            rm -rf node_modules 2>/dev/null || true
            mkdir -p ~/.npm

            # Permissions sanity
            sudo chown -R "$(whoami):$(whoami)" . 2>/dev/null || true
            sudo chmod -R 755 . 2>/dev/null || true

            # Configure npm for flaky networks
            npm config set cache ~/.npm
            npm config set registry https://registry.npmmirror.com/
            npm config set fetch-timeout 180000
            npm config set fetch-retry-mintimeout 15000
            npm config set fetch-retry-maxtimeout 180000
            npm config set fetch-retries 6
            npm config set loglevel verbose
            npm config set maxsockets 1
            npm config set prefer-offline true
            
            echo "📋 npm configuration:"
            npm --version
            npm config get registry

            # Install dependencies with retry (up to 5 attempts, fallback to npmjs on last 3 attempts)
            echo "📦 Installing dependencies (npm ci)..."
            ATTEMPT=1
            MAX_ATTEMPTS=5
            INSTALL_OK=0
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ℹ️ npm ci attempt $ATTEMPT of $MAX_ATTEMPTS"
              if timeout 1200 npm ci --legacy-peer-deps --ignore-scripts --no-audit --no-fund 2>&1 | tee npm-install-$ATTEMPT.log; then
                echo "✅ npm ci succeeded on attempt $ATTEMPT"
                INSTALL_OK=1
                break
              fi
              echo "⚠️ npm ci attempt $ATTEMPT failed"

              if grep -q "ECONNRESET\|ETIMEDOUT\|EHOSTUNREACH" npm-install-$ATTEMPT.log; then
                echo "🌐 Network error detected"
                if [ $ATTEMPT -eq 2 ]; then
                  echo "🔄 Switching registry to https://registry.npmjs.org/ for retries"
                  npm config set registry https://registry.npmjs.org/
                fi
                ATTEMPT=$((ATTEMPT+1))
                sleep 15
                continue
              else
                echo "🛑 Non-network error, stopping retries"
                ATTEMPT=$((ATTEMPT+1))
                break
              fi
            done
            if [ $INSTALL_OK -ne 1 ]; then
              echo "❌ npm ci failed after $((ATTEMPT-1)) attempts"
              tail -80 npm-install-$((ATTEMPT-1)).log || true
              exit 1
            fi

            # Generate Prisma client
            echo "🔧 Generating Prisma client..."
            npx prisma generate
            
            # Set all required environment variables for build
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=4096"
            export NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            export NEXTAUTH_URL="https://naukrimili.com"
            export NEXT_PUBLIC_APP_URL="https://naukrimili.com"
            export DATABASE_URL="$DATABASE_URL"
            export SKIP_ENV_VALIDATION=1

            # Build with full environment context
            echo "🔨 Building application..."
            echo "Environment check:"
            echo "NODE_ENV: $NODE_ENV"
            echo "DATABASE_URL: ${DATABASE_URL:0:20}..."
            echo "NEXTAUTH_URL: $NEXTAUTH_URL"
            
            if ! npm run build 2>&1 | tee build.log; then
              echo "❌ Build failed"
              tail -100 build.log
              exit 1
            fi
            
            echo "✅ Build completed successfully"

            # Create logs directory
            mkdir -p ./logs

            # Start with PM2
            echo "🚀 Starting application with PM2..."
            pm2 start ecosystem.config.cjs --env production --update-env

            sleep 3

            # Quick health check (3 attempts)
            echo "🏥 Health check..."
            for i in {1..3}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:3000/api/health 2>/dev/null || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Health check passed (HTTP $HTTP_CODE)"
                break
              else
                echo "⚠️ Attempt $i/3 failed (HTTP $HTTP_CODE)"
                [ $i -lt 3 ] && sleep 2
              fi
            done

            # Save PM2 process list
            pm2 save

            echo "✅ Deployment completed successfully!"
