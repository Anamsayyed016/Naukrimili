name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        timeout: 15m
        command_timeout: 12m
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          cd /var/www/naukrimili
          echo "ğŸ“ Working in: $(pwd)"
          
          pm2 stop naukrimili 2>/dev/null || true
          pm2 delete naukrimili 2>/dev/null || true
          
          git fetch origin main
          git reset --hard origin/main
          git pull origin main
          
          rm -rf .next
          
          npm ci --legacy-peer-deps --ignore-scripts --no-audit --no-fund || npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
          
          npx prisma generate
          
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          export NODE_OPTIONS="--max-old-space-size=4096"
          npm run build
          
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          
          echo "âœ… Build completed"
          
          mkdir -p ./logs
          
          pm2 start ecosystem.config.cjs --env production --update-env
          
          sleep 10
          pm2 status
          
          for i in {1..5}; do
            if curl -f -s --max-time 10 http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              break
            else
              echo "âŒ Health check failed (attempt $i/5)"
              sleep 5
            fi
          done
          
          pm2 save
          echo "âœ… Deployment completed!"
