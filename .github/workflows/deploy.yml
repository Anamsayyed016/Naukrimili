name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e
            echo "🚀 Starting deployment..."
            
            cd /var/www/naukrimili
            echo "📁 Working in: $(pwd)"
            
            # Stop PM2 process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            git pull origin main
            
            # Clean build
            rm -rf .next
            
            # Install dependencies
            echo "📦 Installing dependencies..."
            # Try npm ci first, fallback to npm install if lock file is out of sync
            npm ci --legacy-peer-deps --ignore-scripts --no-audit --no-fund 2>/dev/null || {
              echo "⚠️ package-lock.json out of sync, using npm install..."
              npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
            }
            
            # Ensure cross-env is installed (required for build script)
            echo "🔧 Ensuring build dependencies..."
            npm install cross-env --save-dev --legacy-peer-deps || {
              echo "⚠️ cross-env installation failed, will use fallback build method"
            }
            
            # Generate Prisma client
            echo "🔧 Generating Prisma client..."
            npx prisma generate
            
            # Set environment variables
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=4096"
            export NEXTAUTH_SECRET="naukrimili-secret-key-2024-production-deployment"
            export NEXTAUTH_URL="https://naukrimili.com"
            
            # Build with error handling and fallback
            echo "🔨 Building application..."
            if npm run build 2>&1; then
              echo "✅ Build completed successfully"
            else
              echo "❌ Build failed with npm run build"
              echo "🔄 Trying fallback build command (without cross-env)..."
              # Fallback: Build directly with environment variables set
              if NODE_ENV=production \
                NEXT_TELEMETRY_DISABLED=1 \
                NODE_OPTIONS="--max-old-space-size=4096" \
                NEXTAUTH_SECRET="naukrimili-secret-key-2024-production-deployment" \
                NEXTAUTH_URL="https://naukrimili.com" \
                npx next build 2>&1; then
                echo "✅ Fallback build completed successfully"
              else
                echo "❌ Fallback build also failed"
                echo "📋 Checking for common build issues..."
                echo "  - Node version: $(node --version)"
                echo "  - npm version: $(npm --version)"
                echo "  - .next directory exists: $([ -d .next ] && echo 'yes' || echo 'no')"
                echo "  - package.json exists: $([ -f package.json ] && echo 'yes' || echo 'no')"
                echo "  - node_modules exists: $([ -d node_modules ] && echo 'yes' || echo 'no')"
                exit 1
              fi
            fi
            
            # Verify build output
            if [ ! -d ".next" ]; then
              echo "❌ .next directory not found after build"
              exit 1
            fi
            
            # Verify static directory exists (critical for production)
            if [ ! -d ".next/static" ]; then
              echo "⚠️ .next/static directory missing - creating it..."
              mkdir -p .next/static
              echo "⚠️ Manual static directory created, but this indicates a build issue"
            fi
            
            # Verify static directory has content
            if [ -z "$(ls -A .next/static 2>/dev/null)" ]; then
              echo "⚠️ .next/static directory is empty - this may cause runtime issues"
            else
              echo "✅ Static files generated successfully"
            fi
            
            echo "✅ Build completed"
            
            # Create logs directory
            mkdir -p ./logs
            
            # Start with PM2
            echo "🚀 Starting application with PM2..."
            
            # Check if ecosystem.config.cjs exists
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "❌ ecosystem.config.cjs not found!"
              exit 1
            fi
            
            # Stop and delete existing process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true
            
            # Start PM2 with production environment
            pm2 start ecosystem.config.cjs --env production --update-env
            
            # Wait for app to start and verify PM2 status
            echo "⏳ Waiting for application to start..."
            sleep 10
            
            # Check PM2 status
            echo "📊 PM2 Status:"
            pm2 status
            
            # Verify PM2 process is running
            PM2_STATUS=$(pm2 jlist | grep -o '"status":"[^"]*"' | head -1 || echo "")
            if ! pm2 list | grep -q "naukrimili.*online"; then
              echo "❌ PM2 process is not online"
              echo "📋 PM2 Status Details:"
              pm2 describe naukrimili || echo "Process not found"
              echo ""
              echo "📋 PM2 Error Logs (last 100 lines):"
              pm2 logs naukrimili --err --lines 100 --nostream || echo "No error logs"
              echo ""
              echo "📋 PM2 Output Logs (last 50 lines):"
              pm2 logs naukrimili --out --lines 50 --nostream || echo "No output logs"
              echo ""
              echo "🔍 Checking if port 3000 is in use:"
              netstat -tlnp 2>/dev/null | grep 3000 || ss -tlnp 2>/dev/null | grep 3000 || echo "Port 3000 not found"
              echo ""
              echo "🔍 Checking if .next directory exists:"
              ls -la .next/ 2>/dev/null | head -10 || echo ".next directory not found"
              exit 1
            fi
            
            echo "✅ PM2 process is running"
            
            # Health check with better error handling
            echo "🏥 Starting health check..."
            HEALTH_CHECK_PASSED=false
            for i in {1..5}; do
              echo "  Attempt $i/5: Checking http://localhost:3000/api/health..."
              
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:3000/api/health 2>/dev/null || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Health check passed! (HTTP $HTTP_CODE)"
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "⚠️ Health check failed (HTTP $HTTP_CODE) - attempt $i/5"
                if [ $i -lt 5 ]; then
                  echo "  Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "❌ Health check failed after 5 attempts"
              echo ""
              echo "📋 PM2 Status:"
              pm2 status
              echo ""
              echo "📋 PM2 Error Logs (last 100 lines):"
              pm2 logs naukrimili --err --lines 100 --nostream || echo "No error logs"
              echo ""
              echo "📋 PM2 Output Logs (last 100 lines):"
              pm2 logs naukrimili --out --lines 100 --nostream || echo "No output logs"
              echo ""
              echo "📋 PM2 Process Details:"
              pm2 describe naukrimili || echo "Process not found"
              echo ""
              echo "🌐 Testing if port 3000 is listening:"
              netstat -tlnp 2>/dev/null | grep 3000 || ss -tlnp 2>/dev/null | grep 3000 || echo "Port 3000 not found in listening ports"
              echo ""
              echo "🔍 Testing localhost connection:"
              curl -v http://localhost:3000 2>&1 | head -20 || echo "Connection failed"
              echo ""
              echo "🔍 Checking server.cjs exists:"
              ls -la server.cjs || echo "server.cjs not found"
              exit 1
            fi
            
            # Save PM2 process list
            pm2 save
            
            echo "✅ Deployment completed successfully!"
