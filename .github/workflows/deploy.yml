name: ðŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy via SSH (Build on Server)
      uses: appleboy/ssh-action@v1.0.3
      timeout-minutes: 40
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        timeout: 35m
        command_timeout: 30m
        script: |
          #!/bin/bash
          set -e
          echo "ðŸš€ Starting deployment at $(date)"
          
          # Navigate to project directory
          cd /var/www/naukrimili
          echo "ðŸ“ Working in: $(pwd)"
          
          # Stop PM2 first to free up memory
          echo "ðŸ›‘ Stopping PM2..."
          pm2 stop naukrimili 2>/dev/null || true
          pm2 delete naukrimili 2>/dev/null || true
          
          # Pull latest code from git
          echo "ðŸ“¥ Pulling latest code..."
          timeout 2m git fetch origin main || echo "Fetch completed"
          timeout 1m git reset --hard origin/main || echo "Reset completed"
          timeout 2m git pull origin main || echo "Pull completed"
          
          # Clean previous builds
          echo "ðŸ§¹ Cleaning previous builds..."
          rm -rf .next
          
          # Install/update dependencies
          echo "ðŸ“¦ Installing dependencies..."
          timeout 10m npm ci --legacy-peer-deps --ignore-scripts --no-audit --no-fund || {
            echo "âš ï¸ npm ci failed, trying npm install..."
            timeout 10m npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
          }
          
          # Generate Prisma client
          echo "ðŸ—„ï¸ Generating Prisma client..."
          timeout 5m npx prisma generate || {
            echo "âš ï¸ Prisma generate timed out"
            exit 1
          }
          
          # Build application
          echo "ðŸ”¨ Building application..."
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          # Build with timeout (30 minutes max)
          timeout 30m npm run build || {
            echo "âŒ Build timed out or failed"
            exit 1
          }
          
          # Verify build
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "âœ… Build completed"
          du -sh .next
          
          # Create logs directory
          mkdir -p ./logs
          
          # Start with PM2
          echo "ðŸš€ Starting with PM2..."
          pm2 start ecosystem.config.cjs --env production --update-env 2>&1 || {
            echo "âš ï¸ PM2 start encountered an issue, checking if already running..."
          }
          
          # Wait for startup
          echo "â³ Waiting for app to initialize..."
          sleep 15
          
          # Check status
          echo "ðŸ“Š PM2 Status:"
          pm2 list 2>&1 | grep -E "naukrimili|online|status" | head -5 || pm2 status | head -5
          
          # Health check
          echo "ðŸ¥ Running health check..."
          HEALTH_PASSED=false
          for i in {1..5}; do
            if curl -f -s --max-time 10 http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              HEALTH_PASSED=true
              break
            else
              echo "âŒ Health check failed (attempt $i/5)"
              if [ $i -lt 5 ]; then
                sleep 5
              fi
            fi
          done
          
          # Save PM2 configuration
          echo "ðŸ’¾ Saving PM2 config..."
          pm2 save --force 2>&1 | head -3 || echo "PM2 config saved"
          
          if [ "$HEALTH_PASSED" = true ]; then
            echo "âœ… Deployment completed successfully!"
          else
            echo "âš ï¸ Deployment completed but health check failed"
            pm2 logs naukrimili --lines 10 --nostream 2>&1 | head -10 || true
          fi
          
          echo "ðŸŽ¯ Deployment script finished at $(date)"
          
          # Kill any lingering pm2 processes
          pkill -9 -f "pm2 logs" 2>/dev/null || true
          pkill -9 -f "pm2 monit" 2>/dev/null || true
          
          # Close file descriptors
          exec 1>&-
          exec 2>&-
          
          # Force exit
          exit 0
