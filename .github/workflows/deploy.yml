name: 🚀 Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: |
        echo "📦 Installing dependencies with Node $(node --version)..."
        npm install --legacy-peer-deps --engine-strict=false --force
        
    - name: 🔨 Build application
      run: |
        echo "🔨 Building application with Node $(node --version)..."
        export NEXT_TELEMETRY_DISABLED=1
        export NODE_ENV=production
        npm run build
        
    - name: 🚀 Deploy to Production Server
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        timeout: 15m
        command_timeout: 12m
        script: |
          set -e
          echo "🚀 Starting production deployment..."
          
          # Test SSH connection
          echo "🔍 Testing SSH connection..."
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Available space: $(df -h . | tail -1)"
          
          # Navigate to project directory
          cd /var/www/jobportal
          echo "📁 Working in: $(pwd)"
          
          # Verify we can access the directory
          if [ ! -d "/var/www/jobportal" ]; then
            echo "❌ Project directory /var/www/jobportal not found"
            echo "📋 Creating directory..."
            mkdir -p /var/www/jobportal
            cd /var/www/jobportal
          fi
          
          # Check Node version and install if needed
          NODE_VERSION=$(node --version 2>/dev/null || echo "not-installed")
          echo "🔍 Current Node version: $NODE_VERSION"
          if [[ ! "$NODE_VERSION" =~ ^v20\. ]]; then
            echo "📦 Installing Node.js 20.x..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
            echo "✅ Node.js installed: $(node --version)"
          fi
          
          # Force kill all PM2 processes and clean up
          echo "💀 Force killing all PM2 processes..."
          pm2 kill || true
          pm2 flush || true
          
          # Clean up previous build artifacts
          echo "🧹 Cleaning up previous build artifacts..."
          rm -rf /var/www/jobportal/.next
          rm -rf /var/www/jobportal/node_modules
          rm -rf /var/www/jobportal/package-lock.json
          
          # Copy new code from GitHub
          echo "📥 Copying new code from GitHub..."
          git pull origin main || {
            echo "❌ Git pull failed, trying to reset..."
            git fetch origin main
            git reset --hard origin/main
          }
          
          # Install dependencies
          echo "📦 Installing dependencies..."
          npm install --legacy-peer-deps --engine-strict=false --force
          
          # Generate Prisma client
          echo "🗄️ Generating Prisma client..."
          npx prisma generate
          
          # Build the application
          echo "🔨 Building application..."
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          npm run build
          
          # Start the application with PM2
          echo "🚀 Starting application with PM2..."
          pm2 start ecosystem.config.cjs --env production --no-daemon
          
          # Health check with retries and timeout
          echo "🏥 Performing health check..."
          HEALTH_CHECK_PASSED=false
          for i in {1..5}; do
            echo "Health check attempt $i/5..."
            
            # Check if PM2 process is still running
            PM2_STATUS=$(pm2 list --format json | jq -r '.[] | select(.name=="jobportal") | .pm2_env.status' 2>/dev/null || echo "errored")
            if [ "$PM2_STATUS" != "online" ]; then
              echo "⚠️ PM2 process is not online (status: $PM2_STATUS), attempting restart..."
              pm2 restart jobportal || pm2 start ecosystem.config.cjs --env production --no-daemon
              sleep 10
              continue
            fi
            
            # Try health check with timeout
            if curl -f -s --max-time 10 http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "✅ Health check passed!"
              HEALTH_CHECK_PASSED=true
              break
            else
              echo "❌ Health check failed (attempt $i/5), waiting 10 seconds..."
              sleep 10
            fi
          done
          
          # Show logs for debugging
          echo "📋 PM2 logs:"
          pm2 logs jobportal --lines 20
          
          # Final status check
          echo "🔍 Final status check..."
          pm2 status
          
          # Check if health check passed
          if [ "$HEALTH_CHECK_PASSED" = false ]; then
            echo "⚠️ Health check failed after 5 attempts, but deployment may still be successful"
            echo "📋 Final PM2 status:"
            pm2 status
            echo "📋 Final PM2 logs:"
            pm2 logs jobportal --lines 20
            
            # Check if PM2 process is at least running
            PM2_FINAL_STATUS=$(pm2 list --format json | jq -r '.[] | select(.name=="jobportal") | .pm2_env.status' 2>/dev/null || echo "errored")
            if [ "$PM2_FINAL_STATUS" = "online" ]; then
              echo "✅ PM2 process is running, deployment completed with warnings"
              echo "🌐 Application should be available at: http://localhost:3000"
              exit 0
            else
              echo "❌ PM2 process is not running properly. Status: $PM2_FINAL_STATUS"
              exit 1
            fi
          fi
          
          echo "✅ Production deployment completed successfully!"
          echo "🌐 Application is available at: http://localhost:3000"