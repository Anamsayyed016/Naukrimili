name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'naukrimili-secret-key-2024-production-deployment' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          timeout: 60s
          command_timeout: 60m
          envs: NEXTAUTH_SECRET,DATABASE_URL
          script: |
            set -e
            echo "🚀 Starting deployment..."

            cd /var/www/naukrimili
            echo "📁 Working in: $(pwd)"
            
            # Stop PM2 process
            pm2 stop naukrimili 2>/dev/null || true
            pm2 delete naukrimili 2>/dev/null || true

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            git pull origin main
            
            # Aggressive cleanup to prevent npm ENOTEMPTY errors
            echo "🧹 Aggressive cleanup of build artifacts..."
            rm -rf .next node_modules 2>/dev/null || true
            rm -rf /tmp/npm-cache /tmp/npm-tmp 2>/dev/null || true
            
            # Force permission fixes on any leftover files
            echo "🔐 Fixing file permissions..."
            sudo chown -R "$(whoami):$(whoami)" . 2>/dev/null || true
            sudo chmod -R 777 node_modules 2>/dev/null || true
            sudo chmod -R 777 .npm 2>/dev/null || true
            
            # Clear npm cache and verify cleanup
            echo "🗑️ Clearing npm cache..."
            npm cache clean --force --verbose || true
            rm -rf ~/.npm 2>/dev/null || true
            
            # Wait a moment for any file handles to release
            sleep 2
            
            # Double-check node_modules is gone
            if [ -d "node_modules" ]; then
              echo "⚠️ node_modules still exists, forcing removal..."
              find node_modules -type d -exec chmod 777 {} \; 2>/dev/null || true
              find node_modules -type f -exec chmod 666 {} \; 2>/dev/null || true
              rm -rf node_modules 2>/dev/null || true
            fi
            
            # Check for open file handles (diagnostic)
            echo "🔍 Checking for open file handles..."
            lsof +D ./node_modules 2>/dev/null || echo "✅ No open file handles detected"
            
            # Configure npm for fast, reliable installs
            npm config set cache ~/.npm
            npm config set registry https://registry.npmjs.org/
            npm config set fetch-timeout 60000
            npm config set fetch-retry-mintimeout 10000
            npm config set fetch-retry-maxtimeout 60000
            npm config set loglevel verbose
            
            # Test registry connectivity
            echo "🌐 Testing npm registry connectivity..."
            npm ping --registry https://registry.npmjs.org/ || echo "⚠️ Registry ping failed, but continuing..."
            
            # Show npm version and config
            echo "📋 npm configuration:"
            npm --version
            npm config list
            
            # Install dependencies deterministically using lockfile
            echo "📦 Installing production dependencies (npm ci)..."
            export npm_config_loglevel=verbose
            
            if ! timeout 300 npm ci --omit=dev --legacy-peer-deps --ignore-scripts --no-audit --no-fund 2>&1 | tee npm-install.log; then
              echo "⚠️ npm ci failed, showing last 100 lines of output..."
              tail -100 npm-install.log
              
              # If ENOTEMPTY error, try recovery
              if grep -q "ENOTEMPTY" npm-install.log; then
                echo "🔧 ENOTEMPTY detected, attempting recovery..."
                echo "Removing node_modules and retrying..."
                rm -rf node_modules
                sleep 2
                npm ci --omit=dev --legacy-peer-deps --ignore-scripts --no-audit --no-fund --verbose 2>&1 | tee npm-install-retry.log
              else
                echo "❌ Different npm ci error detected"
                echo "Full error log:"
                cat npm-install.log
                exit 1
              fi
            fi

            # Generate Prisma client
            echo "🔧 Generating Prisma client..."
            npx prisma generate
            
            # Set all required environment variables for build
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=4096"
            export NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            export NEXTAUTH_URL="https://naukrimili.com"
            export NEXT_PUBLIC_APP_URL="https://naukrimili.com"
            export DATABASE_URL="$DATABASE_URL"
            export SKIP_ENV_VALIDATION=1

            # Build with full environment context
            echo "🔨 Building application..."
            echo "Environment check:"
            echo "NODE_ENV: $NODE_ENV"
            echo "DATABASE_URL: ${DATABASE_URL:0:20}..." 
            echo "NEXTAUTH_URL: $NEXTAUTH_URL"
            
            if ! npm run build 2>&1 | tee build.log; then
              echo "❌ Build failed"
              echo "=== LAST 100 LINES OF BUILD LOG ==="
              tail -100 build.log
              
              # Check for specific errors
              if grep -q "ERR!" build.log; then
                echo "=== NPM BUILD ERRORS ==="
                grep "ERR!" build.log
              fi
              if grep -q "error TS" build.log; then
                echo "=== TYPESCRIPT ERRORS ==="
                grep "error TS" build.log
              fi
              
              exit 1
            fi
            
            echo "✅ Build completed successfully"

            # Create logs directory
            mkdir -p ./logs

            # Start with PM2
            echo "🚀 Starting application with PM2..."
            pm2 start ecosystem.config.cjs --env production --update-env

            sleep 3

            # Quick health check (3 attempts instead of 5)
            echo "🏥 Health check..."
            for i in {1..3}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:3000/api/health 2>/dev/null || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Health check passed (HTTP $HTTP_CODE)"
                break
              else
                echo "⚠️ Attempt $i/3 failed (HTTP $HTTP_CODE)"
                [ $i -lt 3 ] && sleep 2
              fi
            done

            # Save PM2 process list
            pm2 save

            echo "✅ Deployment completed successfully!"
