#!/bin/bash

###############################################################################
# üîç VPS MALWARE SCANNER - REMOTE SCAN ONLY (NO CHANGES)
# 
# Purpose: Scan VPS for malware without making any changes
# Run this FIRST to assess the situation before remediation
###############################################################################

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

LOG_FILE="/tmp/vps-malware-scan-$(date +%Y%m%d-%H%M%S).log"

log() {
    echo -e "${2:-$GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" | tee -a "$LOG_FILE"
}

log_warn() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1" | tee -a "$LOG_FILE"
}

MALWARE_PATTERNS=("xmrig" "syssls" "systemhelper" "cryptonight" "monero" "minerd" "cpuminer")
SUSPICIOUS_PROCESSES=("xmrig" "syssls" "systemhelper" "minerd" "cpuminer")

log "üîç VPS Malware Scanner - READ-ONLY MODE" "$BLUE"
log "========================================"
log "Log file: $LOG_FILE"
log ""

###############################################################################
# SCAN 1: Running Processes
###############################################################################
log "üìä SCAN 1: Running Processes" "$BLUE"

FOUND_PROCESSES=0
for pattern in "${SUSPICIOUS_PROCESSES[@]}"; do
    if pgrep -f "$pattern" >/dev/null 2>&1; then
        log_error "SUSPICIOUS PROCESS: $pattern"
        ps aux | grep -i "$pattern" | grep -v grep | tee -a "$LOG_FILE"
        FOUND_PROCESSES=$((FOUND_PROCESSES + 1))
    fi
done

if [ $FOUND_PROCESSES -eq 0 ]; then
    log "‚úÖ No suspicious processes found"
fi

###############################################################################
# SCAN 2: File System
###############################################################################
log "üìÅ SCAN 2: File System Scan" "$BLUE"

SCAN_DIRS=("/tmp" "/var/tmp" "/dev/shm" "/root" "/usr/local/bin" "/usr/bin" "/opt" "/home")
FOUND_FILES=0

for dir in "${SCAN_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        for pattern in "${MALWARE_PATTERNS[@]}"; do
            while IFS= read -r file; do
                if [ -n "$file" ] && [ -f "$file" ]; then
                    log_error "MALWARE FILE: $file"
                    ls -lah "$file" | tee -a "$LOG_FILE"
                    file "$file" | tee -a "$LOG_FILE"
                    FOUND_FILES=$((FOUND_FILES + 1))
                fi
            done < <(find "$dir" -type f -iname "*$pattern*" 2>/dev/null | head -20 || true)
        done
    fi
done

if [ $FOUND_FILES -eq 0 ]; then
    log "‚úÖ No malware files found in common locations"
fi

###############################################################################
# SCAN 3: Cron Jobs
###############################################################################
log "‚è∞ SCAN 3: Cron Jobs" "$BLUE"

FOUND_CRON=0
for user in $(cut -d: -f1 /etc/passwd); do
    CRON_FILE=""
    [ -f "/var/spool/cron/crontabs/$user" ] && CRON_FILE="/var/spool/cron/crontabs/$user"
    [ -f "/var/spool/cron/$user" ] && CRON_FILE="/var/spool/cron/$user"
    
    if [ -n "$CRON_FILE" ] && [ -f "$CRON_FILE" ]; then
        for pattern in "${MALWARE_PATTERNS[@]}"; do
            if grep -qi "$pattern" "$CRON_FILE" 2>/dev/null; then
                log_error "MALICIOUS CRON in $CRON_FILE"
                grep -i "$pattern" "$CRON_FILE" | tee -a "$LOG_FILE"
                FOUND_CRON=$((FOUND_CRON + 1))
            fi
        done
    fi
done

# System cron
for cron_dir in /etc/cron.d /etc/cron.daily /etc/cron.hourly; do
    [ -d "$cron_dir" ] || continue
    for file in "$cron_dir"/*; do
        [ -f "$file" ] || continue
        for pattern in "${MALWARE_PATTERNS[@]}"; do
            if grep -qi "$pattern" "$file" 2>/dev/null; then
                log_error "MALICIOUS SYSTEM CRON: $file"
                grep -i "$pattern" "$file" | tee -a "$LOG_FILE"
                FOUND_CRON=$((FOUND_CRON + 1))
            fi
        done
    done
done

if [ $FOUND_CRON -eq 0 ]; then
    log "‚úÖ No malicious cron jobs found"
fi

###############################################################################
# SCAN 4: Network Connections
###############################################################################
log "üåê SCAN 4: Network Connections" "$BLUE"

if command -v netstat >/dev/null 2>&1 || command -v ss >/dev/null 2>&1; then
    SUSPICIOUS_CONNS=$(ss -tunap 2>/dev/null | grep -E "xmrig|mining|stratum" || netstat -tunap 2>/dev/null | grep -E "xmrig|mining|stratum" || echo "")
    if [ -n "$SUSPICIOUS_CONNS" ]; then
        log_warn "Suspicious network connections found:"
        echo "$SUSPICIOUS_CONNS" | tee -a "$LOG_FILE"
    else
        log "‚úÖ No suspicious network connections"
    fi
fi

###############################################################################
# SCAN 5: System Resource Usage
###############################################################################
log "üíª SCAN 5: System Resource Usage" "$BLUE"

HIGH_CPU=$(ps aux --sort=-%cpu | head -6 | tail -5 | awk '{if($3>50) print $0}' || echo "")
if [ -n "$HIGH_CPU" ]; then
    log_warn "High CPU usage detected:"
    echo "$HIGH_CPU" | tee -a "$LOG_FILE"
fi

###############################################################################
# SUMMARY
###############################################################################
log "" "$BLUE"
log "üìã SCAN SUMMARY" "$BLUE"
log "=============="
log "Suspicious processes: $FOUND_PROCESSES"
log "Malware files: $FOUND_FILES"
log "Malicious cron jobs: $FOUND_CRON"
log "Log file: $LOG_FILE"
log ""

if [ $((FOUND_PROCESSES + FOUND_FILES + FOUND_CRON)) -eq 0 ]; then
    log "‚úÖ No malware indicators detected" "$GREEN"
else
    log_error "‚ö†Ô∏è  MALWARE INDICATORS FOUND - Run remediation script" "$RED"
    log "Next step: Run scripts/security-remediation.sh"
fi

exit 0
